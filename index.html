<!doctype html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map Ta Mob - V51</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --c-orange: #f39200;
            --c-blue: #2897d5;
            --c-green: #95c11f;
            --c-black: #171718;
            --c-white: #ffffff;
            --c-grey: #f4f4f4;
        }

        * { font-family: 'Montserrat', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { overscroll-behavior: none; background-color: var(--c-grey); color: var(--c-black); }

        /* --- UI COMPONENTS STYLE BAUHAUS / STREET --- */
        .btn-bauhaus {
            background: var(--c-white);
            border: 2px solid var(--c-black);
            color: var(--c-black);
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 2px 2px 0 var(--c-black);
            transition: all 0.1s;
            border-radius: 0px;
            cursor: pointer;
        }
        .btn-bauhaus:hover { transform: translate(-1px, -1px); box-shadow: 4px 4px 0 var(--c-black); }
        .btn-bauhaus:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 var(--c-black); }

        .btn-orange { background: var(--c-orange); }
        .btn-blue { background: var(--c-blue); color: var(--c-white); }
        .btn-green { background: var(--c-green); }
        .btn-black { background: var(--c-black); color: var(--c-white); }

        /* --- LAYOUT --- */
        header { 
            height: 50px; 
            background: var(--c-white); 
            border-bottom: 3px solid var(--c-black); 
            display: flex; justify-content: space-between; align-items: center; padding: 0 10px;
            z-index: 30;
        }

        .cockpit-container { display: flex; height: calc(100vh - 74px); overflow: hidden; margin: 12px; border: 2px solid var(--c-black); background: var(--c-white); box-shadow: 6px 6px 0 var(--c-black); }

        /* SIDEBAR GAUCHE */
        .sidebar-left {
            width: 240px; background: var(--c-white); border-right: 2px solid var(--c-black);
            display: flex; flex-direction: row; z-index: 20; flex-shrink: 0;
        }

        .nav-column {
            width: 60px; background: var(--c-black);
            display: flex; flex-direction: column; align-items: center; padding-top: 0;
            overflow-y: auto; flex-shrink: 0;
        }

        .nav-btn {
            width: 100%; height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--c-white); cursor: pointer; transition: all 0.2s; 
            border-bottom: 1px solid #333;
        }
        .nav-btn.active { background: var(--c-orange); color: var(--c-black); box-shadow: inset 3px 0 0 var(--c-black); }
        .nav-icon { font-size: 24px; }
        
        /* COLONNE OUTILS */
        .tools-column { flex: 1; background: var(--c-white); display: flex; flex-direction: column; overflow: hidden; }
        .tools-header { padding: 15px 10px; border-bottom: 2px solid var(--c-black); font-size: 11px; font-weight: 900; text-transform: uppercase; color: var(--c-black); text-align: center; background: var(--c-orange); }
        .tools-grid { padding: 10px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }

        .tool-item {
            display: flex; flex-direction: row; align-items: center; justify-content: flex-start;
            border: 2px solid var(--c-black); background: var(--c-white); padding: 8px 10px;
            cursor: pointer; transition: all 0.1s; min-height: 44px;
            box-shadow: 2px 2px 0 #ddd;
        }
        .tool-item:hover { transform: translate(-2px, -2px); box-shadow: 4px 4px 0 var(--c-black); background: #fff8e1; }

        .type-lieu { border-left: 6px solid var(--c-black); }       
        .type-transport { border-left: 6px solid var(--c-orange); }  
        .type-pro { border-left: 6px solid var(--c-blue); }        
        .type-admin { border-left: 6px solid #6366f1; }      
        .type-loisir { border-left: 6px solid var(--c-green); }     
        .type-frein { border-left: 6px solid #ef4444; }      

        /* MAP AREA */
        .map-stage { flex: 1; background-color: var(--c-white); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #board-container { width: 100%; height: 100%; background: var(--c-white); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #map-transform-layer { width: 100%; height: 100%; position: relative; transform-origin: center center; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        #user-map-img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; z-index: 0; }

        /* --- STYLE PIN (EPINGLE) --- */
        .draggable { 
            position: absolute; z-index: 1000; cursor: grab; 
            transform: translate(-50%, -50%); 
            width: auto; height: auto; 
            transition: transform 0.1s; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }
        .draggable:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); z-index: 1500; }
        
        .pin-head {
            width: 36px; height: 36px; background: var(--c-white); border: 3px solid var(--c-black);
            border-radius: 50% 50% 50% 0; transform: rotate(-45deg);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            margin-bottom: 4px; position: relative;
        }

        .sticker-emoji { font-size: 20px; line-height: 1; transform: rotate(45deg); pointer-events: none; }
        
        .sticker-label { 
            font-size: 9px; font-weight: 800; text-transform: uppercase; color: var(--c-black); 
            background-color: var(--c-orange); padding: 3px 6px; border: 2px solid var(--c-black);
            white-space: nowrap; pointer-events: none; box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            max-width: 120px; overflow: hidden; text-overflow: ellipsis; text-align: center;
        }

        .sticker-input {
            font-size: 10px; font-weight: 700; color: var(--c-black); text-align: center;
            background-color: var(--c-white); border: 2px solid var(--c-black);
            padding: 2px 4px; width: 120px; outline: none; font-family: 'Montserrat', sans-serif;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        .delete-sticker-btn { 
            position: absolute; top: -10px; right: -10px; width: 18px; height: 18px; 
            background: var(--c-black); color: var(--c-white); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; border: 1px solid var(--c-white); 
            opacity: 0; transition: opacity 0.2s; z-index: 20; cursor: pointer; border-radius: 50%;
        }
        .draggable:hover .delete-sticker-btn { opacity: 1; }

        /* SIDEBAR DROITE */
        .sidebar-right { width: 140px; background: var(--c-white); border-left: 2px solid var(--c-black); display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; align-items: center; padding-top: 15px; }
        .zone-btn { width: 90%; margin-bottom: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: var(--c-white); border: 2px solid var(--c-black); font-size: 9px; font-weight: 900; text-transform: uppercase; box-shadow: 3px 3px 0 #ddd; transition: all 0.1s; }
        .zone-btn:hover { transform: translate(-2px, -2px); box-shadow: 5px 5px 0 var(--c-black); }

        .v-progress-track { width: 12px; height: 120px; background: var(--c-grey); border: 2px solid var(--c-black); margin: 20px 0; position: relative; overflow: hidden; }
        .v-progress-fill { width: 100%; background: var(--c-green); position: absolute; bottom: 0; left: 0; transition: height 0.5s ease; border-top: 2px solid var(--c-black); }

        /* MODALS */
        .library-modal, .form-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(23, 23, 24, 0.9); backdrop-filter: grayscale(1); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .library-modal.active, .form-modal.active { opacity: 1; pointer-events: auto; }
        .library-content, .form-content { background: var(--c-white); width: 90%; max-width: 650px; max-height: 85vh; border: 4px solid var(--c-black); box-shadow: 10px 10px 0 var(--c-orange); overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 3px solid var(--c-black); background: var(--c-black); color: var(--c-white); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: var(--c-orange); }
        .modal-close { color: var(--c-white); font-weight: 900; font-size: 18px; cursor: pointer; }
        .library-grid { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; overflow-y: auto; background: var(--c-grey); }
        .map-card { border: 2px solid var(--c-black); background: var(--c-white); cursor: pointer; aspect-ratio: 1/1; position: relative; transition: transform 0.1s; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }
        .map-card:hover { transform: translate(-3px, -3px); box-shadow: 6px 6px 0 var(--c-black); border-color: var(--c-orange); }
        .map-preview { width: 100%; height: 100%; object-fit: cover; background: var(--c-white); display: flex; align-items: center; justify-content: center; color: var(--c-black); font-size: 24px; }
        .map-title { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--c-black); color: var(--c-white); padding: 6px 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; text-align: center; border-top: 2px solid var(--c-black); min-height: 30px; display: flex; align-items: center; justify-content: center; z-index: 20; }

        .zoom-controls { position: absolute; bottom: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 500; }
        .zoom-btn { width: 36px; height: 36px; background: var(--c-white); border: 2px solid var(--c-black); font-weight: 900; color: var(--c-black); box-shadow: 3px 3px 0 var(--c-black); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; }
        
        .circle-zone { position: absolute; border-radius: 50%; border: 3px dashed var(--c-black); pointer-events: none; transform: translate(-50%, -50%); z-index: 100; display:flex; justify-content:center; align-items:center; }

        @media (max-width: 768px) {
            .cockpit-container { flex-direction: column; margin: 0; border: none; height: calc(100vh - 50px); }
            .sidebar-left { width: 100%; height: 60px; border-right: none; border-bottom: 2px solid var(--c-black); flex-direction: row; order: 2; }
            .nav-column { width: auto; flex-direction: row; height: 100%; overflow-x: auto; background: var(--c-black); }
            .nav-btn { width: 60px; height: 100%; border-bottom: none; border-right: 1px solid #333; }
            .tools-column { display: none; }
            .sidebar-right { display: none; }
            .map-stage { height: 100%; order: 1; }
        }
    </style>
</head>
<body class="flex flex-col h-full overflow-hidden text-slate-800">

    <header>
        <div class="flex items-center gap-3">
            <img src="https://static.wixstatic.com/media/dd5dab_47743b1c86024865ba19e623a3db327f~mv2.avif/v1/fill/w_224,h_60,al_c,q_80,enc_avif,quality_auto/dd5dab_47743b1c86024865ba19e623a3db327f~mv2.avif" alt="Logo" class="h-8 w-auto">
            <span class="font-black text-sm uppercase tracking-tight text-black hidden sm:inline">Map Ta Mob</span>
        </div>
        <div class="flex gap-2">
            <a href="https://mlpb-tools.github.io/diagmob360/" target="_blank" class="btn-bauhaus px-2 py-1 text-[10px] flex items-center gap-1" style="background:#e0e7ff; color:#3730a3;">
                <span>üìä</span> Diag 360
            </a>
            <button onclick="toggleLibrary()" class="btn-bauhaus btn-orange px-2 py-1 text-[10px]">üìö Biblio</button>
            <button onclick="downloadMapPDF()" class="btn-bauhaus btn-black px-2 py-1 text-[10px] flex items-center gap-1"><span>üìÑ</span> PDF</button>
        </div>
    </header>

    <div class="cockpit-container">
        <!-- SIDEBAR GAUCHE -->
        <aside class="sidebar-left">
            <div class="nav-column">
                <div onclick="switchTab('lieux', this)" class="nav-btn active" title="Lieux"><span class="nav-icon">üè†</span></div>
                <div onclick="switchTab('transports', this)" class="nav-btn" title="Mobilit√©"><span class="nav-icon">üöå</span></div>
                <div onclick="switchTab('pro', this)" class="nav-btn" title="Avenir"><span class="nav-icon">üíº</span></div>
                <div onclick="switchTab('admin', this)" class="nav-btn" title="Sant√©"><span class="nav-icon">‚öïÔ∏è</span></div>
                <div onclick="switchTab('loisirs', this)" class="nav-btn" title="Social"><span class="nav-icon">üéâ</span></div>
                <div onclick="switchTab('freins', this)" class="nav-btn" title="Obstacles"><span class="nav-icon">üöß</span></div>
            </div>
            
            <div class="tools-column">
                <div id="tools-title" class="tools-header">Ancrage</div>
                <div class="flex-1 overflow-y-auto bg-white" id="tools-container">
                    <!-- Injection JS -->
                </div>
            </div>
        </aside>

        <!-- CENTRE MAP -->
        <main class="map-stage">
            <div id="board-container">
                <div id="map-transform-layer">
                    <div id="placeholder-text" class="absolute flex flex-col items-center justify-center text-slate-400 pointer-events-none opacity-80 bg-white p-6 border-2 border-black shadow-[4px_4px_0_black]">
                        <span class="text-5xl mb-3 text-orange-500">üó∫Ô∏è</span>
                        <span class="font-black text-xs uppercase text-center text-black tracking-widest">Choisis un mod√®le<br>dans la biblioth√®que</span>
                    </div>
                    <img id="user-map-img" src="" class="hidden" alt="Fond">
                    <div id="drop-zone" class="absolute inset-0 z-10 w-full h-full"></div>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="resetZoom()">1:1</button>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                </div>
            </div>
            <div id="toast-message" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 border-2 border-orange-500 shadow-[4px_4px_0_#f39200] z-50 text-xs font-black uppercase hidden pointer-events-none"></div>
        </main>

        <!-- SIDEBAR DROITE -->
        <aside class="sidebar-right">
            <span class="text-[10px] font-black uppercase text-black mb-3 bg-orange-500 px-2 py-1 border border-black shadow-[2px_2px_0_black]">Zones</span>
            <button onclick="addZone(150, 'rgba(149, 193, 31, 0.2)', '#95c11f', 'CONFORT')" class="zone-btn" style="border-color:#95c11f;"><span class="text-xl">üòé</span><span style="color:#95c11f">Confort</span></button>
            <button onclick="addZone(250, 'rgba(243, 146, 0, 0.2)', '#f39200', 'EFFORT')" class="zone-btn" style="border-color:#f39200;"><span class="text-xl">ü§î</span><span style="color:#f39200">Effort</span></button>
            <button onclick="addZone(350, 'rgba(239, 68, 68, 0.2)', '#ef4444', 'GAL√àRE')" class="zone-btn" style="border-color:#ef4444;"><span class="text-xl">üö´</span><span style="color:#ef4444">Gal√®re</span></button>
            <div class="flex-1"></div>
            <span class="text-[10px] font-black uppercase text-black mb-1 bg-blue-400 px-2 py-1 border border-black shadow-[2px_2px_0_black]">Score</span>
            <span id="progress-text" class="text-sm font-black text-black mt-2">0%</span>
            <div class="v-progress-track"><div id="progress-bar" class="v-progress-fill h-0"></div></div>
        </aside>
    </div>

    <!-- MODALE BIBLIOTH√àQUE -->
    <div id="library-modal" class="library-modal">
        <div class="library-content">
            <div class="modal-header"><h3>Biblioth√®que</h3><span class="modal-close" onclick="toggleLibrary()">‚úï</span></div>
            <div class="library-grid" id="library-grid">
                <label for="lib-upload-input" class="map-card flex flex-col items-center justify-center bg-white border-2 border-dashed border-gray-400 hover:border-orange-500 text-gray-400 hover:text-orange-500">
                    <span style="font-size:32px;">+</span><span style="font-size:10px; font-weight:800;">IMPORTER</span>
                    <input type="file" id="lib-upload-input" class="hidden" accept="image/*" onchange="handleLibraryUpload(event)">
                </label>
            </div>
        </div>
    </div>

    <!-- MODALE COVOITURAGE -->
    <div id="covoit-modal" class="form-modal">
        <div class="form-content">
            <div class="modal-header"><h3>üöò Fiche Covoiturage</h3><span class="modal-close" onclick="closeCovoitModal()">‚úï</span></div>
            <div class="p-6 bg-gray-50 space-y-4">
                <div><label class="block text-[10px] font-black mb-1">DESTINATION</label><input type="text" id="covoit-dest" class="w-full p-2 border-2 border-black"></div>
                <div><label class="block text-[10px] font-black mb-1">HORAIRES</label><input type="text" id="covoit-horaire" class="w-full p-2 border-2 border-black" placeholder="Ex: 8h-17h"></div>
            </div>
            <div class="p-4 border-t-2 border-black bg-white flex justify-end">
                <button onclick="addCovoitSticker()" class="btn-bauhaus btn-orange px-6 py-2 text-xs">Ajouter</button>
            </div>
        </div>
    </div>

    <script>
        let currentScale = 1;
        let progress = 0;

        const taxonomy = {
            lieux: [
                { icon: "üè†", label: "Maison / Apprt", type: "lieu" },
                { icon: "üè¢", label: "FJT", type: "lieu" },
                { icon: "üõèÔ∏è", label: "H√©berg√©", type: "lieu" },
                { icon: "üèòÔ∏è", label: "Colocation", type: "lieu" }
            ],
            transports: [
                { icon: "üö∂", label: "Marche", type: "transport" },
                { icon: "üöå", label: "Bus", type: "transport" },
                { icon: "üöã", label: "Tram'Bus", type: "transport" },
                { icon: "üö≤", label: "V√©lo Pony", type: "transport" },
                { icon: "üöó", label: "Autopartage Aupa", type: "transport" },
                { icon: "üöê", label: "TAD", type: "transport" },
                { icon: "üöÜ", label: "Train", type: "transport" },
                { icon: "üõµ", label: "Scooter", type: "transport" },
                { icon: "üöò", label: "Voiture", type: "transport" },
                { icon: "üöó", label: "Covoit", type: "transport" },
                { icon: "üöò", label: "Proposer Covoit", type: "transport", action: "openCovoitForm" },
                { icon: "üëç", label: "Auto-Stop", type: "transport" },
                { icon: "üö¶", label: "Auto-√âcole", type: "transport" },
                { icon: "üìñ", label: "Code", type: "transport" }
            ],
            pro: [
                { icon: "üöÄ", label: "Mission Locale", type: "pro" },
                { icon: "üèõÔ∏è", label: "Fr. Travail", type: "pro" },
                { icon: "üè¢", label: "Entreprise", type: "pro", editable: true, placeholder: "Nom..." }, 
                { icon: "üéì", label: "Formation", type: "pro", editable: true, placeholder: "Centre..." },
                { icon: "üßë‚Äçüîß", label: "Stage / Immersion", type: "pro", editable: true, placeholder: "Structure..." },
                { icon: "ü§ù", label: "Volontariat", type: "pro", editable: true, placeholder: "Mission..." }
            ],
            admin: [
                { icon: "üìä", label: "Score", type: "admin", editable: true, placeholder: "Res..." },
                { icon: "üè•", label: "H√¥pital", type: "admin" },
                { icon: "ü©∫", label: "M√©decin", type: "admin" },
                { icon: "üß†", label: "CMP", type: "admin" },
                { icon: "üíä", label: "Pharmacie", type: "admin" },
                { icon: "üë™", label: "Planning", type: "admin" },
                { icon: "üìú", label: "Mairie", type: "admin" },
                { icon: "üí∂", label: "CAF", type: "admin" },
                { icon: "üè¶", label: "Banque", type: "admin" }
            ],
            loisirs: [
                { icon: "ü§ù", label: "B√©n√©volat", type: "loisir" },
                { icon: "üè†", label: "Gaztetxe", type: "loisir" },
                { icon: "üõí", label: "Courses", type: "loisir" },
                { icon: "ü•ñ", label: "√âpicerie", type: "loisir" },
                { icon: "üåä", label: "Oc√©an", type: "loisir" },
                { icon: "‚öΩ", label: "Sport", type: "loisir" },
                { icon: "üé™", label: "F√™tes", type: "loisir" },
                { icon: "‚òï", label: "Caf√©", type: "loisir" }
            ],
            freins: [
                { icon: "üö´", label: "Zone non desservie", type: "frein", editable: true, placeholder: "O√π ?" },
                { icon: "‚è∞", label: "Horaires inadapt√©es", type: "frein", editable: true, placeholder: "Quand ?" },
                { icon: "ü§Ø", label: "Trop compliqu√©", type: "frein", editable: true, placeholder: "Pourquoi ?" }
            ]
        };

        window.onload = () => { renderTools('lieux'); renderLibrary(); };

        function switchTab(id, btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTools(id);
            document.getElementById('tools-title').innerText = { lieux:"Ancrage", transports:"Mobilit√©", pro:"Avenir", admin:"Sant√©", loisirs:"Social", freins:"Obstacles" }[id];
        }

        function renderTools(cat) {
            const container = document.getElementById('tools-container');
            container.innerHTML = '<div class="tools-grid"></div>';
            const grid = container.querySelector('.tools-grid');
            taxonomy[cat].forEach(item => {
                const d = document.createElement('div');
                d.className = `tool-item type-${item.type}`;
                d.innerHTML = `<span style="font-size:20px; margin-right:10px;">${item.icon}</span><span class="text-[9px] font-bold uppercase">${item.label}</span>`;
                d.onclick = () => addToMap(item);
                grid.appendChild(d);
            });
        }

        function addToMap(item) {
            if (item.action === 'openCovoitForm') { openCovoitModal(); return; }
            const el = document.createElement('div');
            el.className = 'draggable pointer-events-auto';
            el.style.left = '50%'; el.style.top = '50%';
            
            let labelHtml = `<span class="sticker-label">${item.label}</span>`;
            if (item.editable) {
                labelHtml = `<div class="flex flex-col items-center"><span class="sticker-label">${item.label}</span><input type="text" class="sticker-input mt-1" placeholder="${item.placeholder}" onclick="event.stopPropagation();this.focus();"></div>`;
            }

            el.innerHTML = `
                <div class="pin-head"><span class="sticker-emoji">${item.icon}</span></div>
                ${labelHtml}
                <div class="delete-sticker-btn" onclick="this.parentElement.remove(); updateProgress(-1);">‚úï</div>
            `;
            enableDrag(el);
            document.getElementById('drop-zone').appendChild(el);
            updateProgress(1);
        }

        function enableDrag(el) {
            let isDragging=false, startX, startY, iL, iT;
            const start = (e) => {
                if(e.target.tagName === 'INPUT') return;
                e.stopPropagation(); isDragging=true; el.style.zIndex=2000;
                const cx=e.touches?e.touches[0].clientX:e.clientX; 
                const cy=e.touches?e.touches[0].clientY:e.clientY;
                startX=cx; startY=cy; iL=parseFloat(el.style.left)||50; iT=parseFloat(el.style.top)||50;
                document.addEventListener('mousemove', move, {passive:false}); 
                document.addEventListener('touchmove', move, {passive:false});
                document.addEventListener('mouseup', end); 
                document.addEventListener('touchend', end);
            };
            const move = (e) => { 
                if(!isDragging) return; 
                e.preventDefault(); 
                const cx=e.touches?e.touches[0].clientX:e.clientX; 
                const cy=e.touches?e.touches[0].clientY:e.clientY; 
                const r=document.getElementById('drop-zone').getBoundingClientRect(); 
                el.style.left=(iL+((cx-startX)/r.width)*100)+'%'; 
                el.style.top=(iT+((cy-startY)/r.height)*100)+'%'; 
            };
            const end = () => { isDragging=false; el.style.zIndex=1000; document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end); };
            el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive:false});
        }

        function addZone(size, bg, border, label) {
            const z = document.createElement('div');
            z.className = 'circle-zone draggable pointer-events-auto';
            z.style.width = size+'px'; z.style.height = size+'px';
            z.style.left = '50%'; z.style.top = '50%';
            z.style.backgroundColor = bg; z.style.border = `3px dashed ${border}`;
            z.innerHTML = `<span class="bg-white border border-black px-1 text-[8px] font-black absolute top-0">${label}</span><div class="delete-sticker-btn" style="opacity:1" onclick="this.parentElement.remove()">‚úï</div>`;
            enableDrag(z);
            document.getElementById('drop-zone').appendChild(z);
        }

        let lib = [
  { id: 1,  name: "Errobi ‚Äì Sud Pays Basque", url: "Errobi-sud-pays-basque.jpg" },
  { id: 2,  name: "Europe", url: "Europe.jpg" },
  { id: 3,  name: "Garazi ‚Äì Baigorri", url: "Garazi-Baigorri.jpg" },

  { id: 4,  name: "Hasparren ‚Äì Adour", url: "Hasparren-Adour.jpg" },
  { id: 5,  name: "Hasparren ‚Äì St Palais", url: "Hasparren-stpalais.jpg" },

  { id: 6,  name: "Navarre transfrontali√®re", url: "Navarre-transfrontalier.jpg" },

  { id: 7,  name: "Adour Ouest", url: "adour-ouest.jpg" },
  { id: 8,  name: "BAB", url: "bab.jpg" },

  { id: 9,  name: "Bordeaux ‚Äì Toulouse ‚Äì Bilbao", url: "bordeaux-toulouse-bilbao.jpg" },
  { id: 10, name: "France", url: "france.jpg" },

  { id: 11, name: "Hendaye ‚Äì St Jean", url: "hendaye-st-jean.jpg" },
  { id: 12, name: "Hendaye transfrontalier", url: "hendaye-transfrontalier.jpg" },

  { id: 13, name: "Saint-Palais ‚Äì Garazi ‚Äì Mauleon", url: "saint-palais-garazi-mauleon.jpg" },
  { id: 14, name: "Ustaritz ‚Äì Cambo", url: "ustaritz-cambo.jpg" }
        ];
        function toggleLibrary() { document.getElementById('library-modal').classList.toggle('active'); }
        function renderLibrary() {
            const g = document.getElementById('library-grid');
            const up = g.firstElementChild; g.innerHTML=''; g.appendChild(up);
            lib.forEach(m => {
                const c = document.createElement('div'); c.className='map-card';
                c.innerHTML=`<div class="map-preview" style="background-image:url('${m.url}');background-size:cover;"></div><div class="map-title">${m.name}</div>`;
                c.onclick=()=>{ document.getElementById('user-map-img').src=m.url; document.getElementById('user-map-img').classList.remove('hidden'); document.getElementById('placeholder-text').classList.add('hidden'); toggleLibrary(); };
                g.appendChild(c);
            });
        }
        function handleLibraryUpload(e) {
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=(ev)=>{ lib.push({id:Date.now(), name:f.name.substring(0,15), url:ev.target.result}); renderLibrary(); };
            r.readAsDataURL(f);
        }

        async function downloadMapPDF() {
            showToast("‚è≥", "G√©n√©ration du PDF...");
            const el = document.getElementById('board-container');
            const canvas = await html2canvas(el, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('landscape', 'mm', 'a4');
            pdf.addImage(imgData, 'JPEG', 0, 0, 297, 210);
            pdf.save('Diagnostic_Mobilite.pdf');
            showToast("‚úÖ", "Document pr√™t");
        }

        function showToast(i,m) { const t=document.getElementById('toast-message'); t.innerHTML=`<span>${i}</span> ${m}`; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2000); }
        function updateProgress(d) { progress=Math.max(0,Math.min(10,progress+d)); document.getElementById('progress-bar').style.height=(progress*10)+'%'; document.getElementById('progress-text').innerText=(progress*10)+'%'; }
        
        function zoomIn() { currentScale+=0.1; updT(); } 
        function zoomOut() { if(currentScale>0.2)currentScale-=0.1; updT(); } 
        function resetZoom() { currentScale=1; updT(); } 
        function updT() { document.getElementById('map-transform-layer').style.transform=`scale(${currentScale})`; }
        function openCovoitModal() { document.getElementById('covoit-modal').classList.add('active'); }
        function closeCovoitModal() { document.getElementById('covoit-modal').classList.remove('active'); }
        function addCovoitSticker() { const d=document.getElementById('covoit-dest').value; addToMap({icon:"üöò", label:"Covoit : "+d, type:"transport"}); closeCovoitModal(); }
    </script>
</body>
</html>
