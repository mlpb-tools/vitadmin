<!doctype html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map Ta Mobilit√© - Studio Avanc√©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        * { font-family: 'Montserrat', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; background-color: #f8fafc; }

        header { height: 44px; }
        footer { height: 24px; font-size: 10px; }

        .cockpit-container {
            display: flex;
            height: calc(100vh - 68px);
            overflow: hidden;
        }

        /* COLONNE GAUCHE */
        .sidebar-left {
            width: 260px;
            background: white;
            border-right: 1px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            z-index: 20;
            flex-shrink: 0;
        }

        /* COLONNE DROITE */
        .sidebar-right {
            width: 140px;
            background: white;
            border-left: 1px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            z-index: 20;
            flex-shrink: 0;
            align-items: center;
            padding-top: 10px;
        }

        /* ZONE CARTE */
        .map-stage {
            flex: 1;
            background-color: #e2e8f0;
            background-image: 
                linear-gradient(45deg, #cbd5e1 25%, transparent 25%), 
                linear-gradient(-45deg, #cbd5e1 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #cbd5e1 75%), 
                linear-gradient(-45deg, transparent 75%, #cbd5e1 75%);
            background-size: 20px 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        #board-container {
            width: 95%;
            height: 95%;
            background: white;
            position: relative;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 2px solid white;
            border-radius: 8px;
            overflow: hidden; /* Important pour masquer ce qui d√©passe lors du zoom */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* COUCHE DE TRANSFORMATION (ZOOM) */
        #map-transform-layer {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: center center;
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #user-map-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
            z-index: 0;
        }

        .draggable {
            position: absolute; z-index: 1000; cursor: grab; transition: transform 0.1s;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); transform: translate(-50%, -50%);
        }
        .draggable:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); }

        .icon-content {
            background: white; border: 1.5px solid #1e293b; border-radius: 6px;
            padding: 2px; min-width: 40px; text-align: center;
        }

        .vertical-tabs { display: flex; flex-direction: row; overflow-x: auto; background: #f1f5f9; flex-shrink: 0; }
        .v-tab-btn { flex: 1; padding: 10px 5px; text-align: center; opacity: 0.6; border-bottom: 3px solid transparent; transition: all 0.2s; min-width: 50px; }
        .v-tab-btn.active { opacity: 1; border-bottom-color: #0f172a; background: white; color: #0f172a; }
        .v-tab-icon { display: block; font-size: 18px; margin-bottom: 2px; }
        .v-tab-label { font-size: 7px; font-weight: 800; text-transform: uppercase; }

        .tools-grid { padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; overflow-y: auto; }
        .tool-item { display: flex; flex-direction: column; items-center; justify-center; border: 1px solid #e2e8f0; border-radius: 6px; padding: 6px 2px; cursor: pointer; transition: all 0.1s; background: white; height: 50px; }
        .tool-item:hover { transform: scale(1.05); border-color: #94a3b8; }
        
        .type-admin { border-color: #bfdbfe; background: #eff6ff; }
        .type-frein { border-color: #fecaca; background: #fef2f2; }
        .type-moyen { border-color: #bbf7d0; background: #f0fdf4; }
        .type-horizon { border-color: #e9d5ff; background: #faf5ff; }

        .zone-btn { width: 90%; margin-bottom: 8px; padding: 8px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; background: white; border: 1px solid; font-size: 9px; font-weight: 800; text-transform: uppercase; }
        .zone-btn:active { transform: scale(0.95); }

        .v-progress-track { width: 8px; height: 100px; background: #e2e8f0; border-radius: 4px; margin: 20px 0; position: relative; overflow: hidden; }
        .v-progress-fill { width: 100%; background: #22c55e; position: absolute; bottom: 0; left: 0; transition: height 0.5s ease; }

        @media (max-width: 768px) {
            .cockpit-container { flex-direction: column; }
            .sidebar-left { width: 100%; height: 25%; order: 2; border-right: none; border-top: 1px solid #cbd5e1; flex-direction: row; }
            .vertical-tabs { flex-direction: column; width: 60px; overflow-y: auto; border-right: 1px solid #e2e8f0; }
            .tools-grid { display: flex; overflow-x: auto; flex: 1; padding: 5px; gap: 5px; grid-template-columns: none; }
            .tool-item { min-width: 50px; }
            .sidebar-right { display: none; }
            .map-stage { height: 75%; order: 1; }
        }

        .circle-zone { position: absolute; border-radius: 50%; border: 2px dashed; pointer-events: none; transform: translate(-50%, -50%); z-index: 100; display:flex; justify-content:center; align-items:center;}
        .chat-overlay { position: absolute; bottom: 10px; right: 10px; width: 280px; height: 350px; background: white; border: 1px solid #cbd5e1; border-radius: 8px; display: flex; flex-direction: column; z-index: 2000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: #f8fafc; font-size: 11px; }
        .chat-bubble { padding: 6px 10px; border-radius: 8px; margin-bottom: 6px; max-width: 90%; }
        .chat-ai { background: #e2e8f0; align-self: flex-start; }
        .chat-user { background: #2563eb; color: white; align-self: flex-end; margin-left: auto; }

        /* CONTROLES DE ZOOM */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 500;
        }
        .zoom-btn {
            width: 32px; height: 32px; background: white; border: 1px solid #94a3b8;
            border-radius: 6px; font-weight: 900; color: #1e293b;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: all 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        .zoom-btn:hover { background: #f1f5f9; }
        .zoom-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex flex-col h-full overflow-hidden text-slate-800">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 px-4 flex justify-between items-center shadow-sm z-30">
        <div class="flex items-center gap-2">
            <img src="https://static.wixstatic.com/media/dd5dab_7e61f61a3fab4046946b861015ab0f2d~mv2.avif/v1/fill/w_124,h_59,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/Design%20sans%20titre.avif" alt="Logo" class="h-5 w-auto">
            <span class="font-black text-xs uppercase tracking-tight text-slate-700 hidden sm:inline">Map Ta Mobilit√©</span>
        </div>
        <div class="flex gap-2">
             <label for="map-upload" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-2 py-1 text-[9px] font-bold rounded border border-slate-300 uppercase flex items-center gap-1 transition-colors">
                <span>üìÇ</span> Importer
            </label>
            <input type="file" id="map-upload" accept="image/*" class="hidden" onchange="handleMapUpload(event)">
            
            <button onclick="saveSession()" class="bg-emerald-500 text-white px-2 py-1 text-[9px] font-bold rounded hover:bg-emerald-600 uppercase transition-colors flex items-center gap-1" title="Enregistrer dans le navigateur">
                üíæ Sauver
            </button>
            <button onclick="loadSession()" class="bg-blue-500 text-white px-2 py-1 text-[9px] font-bold rounded hover:bg-blue-600 uppercase transition-colors flex items-center gap-1" title="Charger la sauvegarde">
                üìÇ Restaurer
            </button>

            <button onclick="analyzeMapWithAI()" id="btn-analyze" class="bg-indigo-600 text-white px-2 py-1 text-[9px] font-bold rounded hover:bg-indigo-500 uppercase transition-colors flex items-center gap-1 ml-2">
                ‚ú® IA
            </button>
            <button onclick="openRoadbook()" class="bg-yellow-400 text-slate-900 px-2 py-1 text-[9px] font-bold rounded hover:bg-yellow-300 uppercase transition-colors">
                PDF
            </button>
        </div>
    </header>

    <!-- COCKPIT -->
    <div class="cockpit-container">
        
        <!-- GAUCHE -->
        <aside class="sidebar-left">
            <div class="vertical-tabs">
                <button onclick="switchTab('lieux')" id="tab-lieux" class="v-tab-btn active"><span class="v-tab-icon">üè†</span><span class="v-tab-label">Lieux</span></button>
                <button onclick="switchTab('moyens')" id="tab-moyens" class="v-tab-btn"><span class="v-tab-icon">üöå</span><span class="v-tab-label">Bus</span></button>
                <button onclick="switchTab('admin')" id="tab-admin" class="v-tab-btn"><span class="v-tab-icon">üÜî</span><span class="v-tab-label">Admin</span></button>
                <button onclick="switchTab('freins')" id="tab-freins" class="v-tab-btn"><span class="v-tab-icon">üöß</span><span class="v-tab-label">Freins</span></button>
                <button onclick="switchTab('horizons')" id="tab-horizons" class="v-tab-btn"><span class="v-tab-icon">üåç</span><span class="v-tab-label">Futur</span></button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-slate-50 relative custom-scrollbar">
                <div id="content-lieux" class="tools-grid"></div>
                <div id="content-moyens" class="tools-grid hidden"></div>
                <div id="content-admin" class="tools-grid hidden"></div>
                <div id="content-freins" class="tools-grid hidden"></div>
                <div id="content-horizons" class="tools-grid hidden"></div>
            </div>
        </aside>

        <!-- CENTRE : MAP STAGE -->
        <main class="map-stage">
            <div id="board-container">
                <!-- COUCHE DE TRANSFORMATION POUR LE ZOOM -->
                <div id="map-transform-layer">
                    <div id="placeholder-text" class="absolute flex flex-col items-center justify-center text-slate-400 pointer-events-none opacity-60">
                        <span class="text-4xl mb-2">üó∫Ô∏è</span>
                        <span class="font-bold text-xs uppercase">Ta carte ici</span>
                    </div>
                    <img id="user-map-img" src="" class="hidden" alt="Fond">
                    <div id="drop-zone" class="absolute inset-0 z-10 w-full h-full"></div>
                </div>
                
                <!-- BOUTONS ZOOM -->
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="resetZoom()">1:1</button>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                </div>

                <!-- Chat Overlay -->
                <div id="chat-overlay" class="chat-overlay hidden">
                    <div class="bg-slate-800 text-white p-2 rounded-t flex justify-between items-center text-xs font-bold">
                        <span>ü§ñ Coach IA</span>
                        <button onclick="toggleChat()" class="hover:text-red-400">‚úï</button>
                    </div>
                    <div id="chat-messages" class="chat-messages">
                        <div class="chat-bubble chat-ai">Pose ta question !</div>
                    </div>
                    <div class="p-2 bg-white border-t border-slate-100 flex gap-1">
                        <input type="text" id="chat-input" class="flex-1 border text-xs p-1 rounded" onkeypress="handleChatKey(event)">
                        <button onclick="sendMessage()" class="bg-blue-600 text-white px-2 rounded text-xs">‚û§</button>
                    </div>
                </div>
            </div>
            
            <div id="toast-message" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-3 py-1 rounded-full shadow-lg z-50 text-[10px] font-bold hidden backdrop-blur-sm pointer-events-none"></div>
        </main>

        <!-- DROITE -->
        <aside class="sidebar-right">
            <span class="text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest">Zones</span>
            <button onclick="addZone(150, 'rgba(34, 197, 94, 0.15)', '#16a34a', 'CONFORT')" class="zone-btn border-green-500 text-green-700 hover:bg-green-50">
                <span class="text-xl">üòé</span> Confort
            </button>
            <button onclick="addZone(250, 'rgba(234, 179, 8, 0.15)', '#ca8a04', 'EFFORT')" class="zone-btn border-yellow-500 text-yellow-700 hover:bg-yellow-50">
                <span class="text-xl">ü§î</span> Effort
            </button>
            <button onclick="addZone(350, 'rgba(239, 68, 68, 0.15)', '#ef4444', 'GAL√àRE')" class="zone-btn border-red-500 text-red-700 hover:bg-red-50">
                <span class="text-xl">üö´</span> Gal√®re
            </button>

            <div class="flex-1"></div>
            
            <span class="text-[9px] font-black uppercase text-slate-400 mb-1 tracking-widest">Score</span>
            <span id="progress-text" class="text-xs font-bold text-blue-600">0%</span>
            <div class="v-progress-track">
                <div id="progress-bar" class="v-progress-fill h-0"></div>
            </div>

            <button onclick="toggleChat()" class="mt-4 mb-4 bg-slate-900 text-white w-10 h-10 rounded-full flex items-center justify-center hover:scale-110 transition-transform shadow-lg">
                <span class="text-lg">üí¨</span>
            </button>
        </aside>

    </div>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-slate-200 flex items-center justify-center text-slate-400 uppercase tracking-widest">
        Mission Locale Pays Basque - Atelier Num√©rique
    </footer>

    <script>
        const apiKey = ""; 
        const contextPrompt = `Tu es l'assistant MLPB. Infos : Txik Txak -28 ans = 20‚Ç¨/mois. Aide permis FAJ.`;
        let placedItems = [];
        
        // --- ZOOM LOGIC ---
        let currentScale = 1;
        
        function zoomIn() {
            currentScale += 0.1;
            updateTransform();
        }
        
        function zoomOut() {
            if (currentScale > 0.2) currentScale -= 0.1;
            updateTransform();
        }
        
        function resetZoom() {
            currentScale = 1;
            updateTransform();
        }
        
        function updateTransform() {
            const layer = document.getElementById('map-transform-layer');
            layer.style.transform = `scale(${currentScale})`;
        }

        // --- SAVE / LOAD LOGIC ---
        function saveSession() {
            const itemsToSave = placedItems.map(item => ({
                label: item.label,
                type: item.type,
                icon: item.icon,
                // On doit r√©cup√©rer les coordonn√©es depuis le DOM
                left: item.el.style.left,
                top: item.el.style.top
            }));
            
            const imgSrc = document.getElementById('user-map-img').src;
            const hasImage = !document.getElementById('user-map-img').classList.contains('hidden');
            
            const data = {
                items: itemsToSave,
                image: hasImage ? imgSrc : null,
                date: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('mlpb_map_data', JSON.stringify(data));
                showToast("üíæ", "Carte sauvegard√©e !");
            } catch (e) {
                showToast("‚ö†Ô∏è", "Erreur: Image trop lourde ?");
                console.error(e);
            }
        }

        function loadSession() {
            const savedData = localStorage.getItem('mlpb_map_data');
            if (!savedData) {
                showToast("‚ö†Ô∏è", "Aucune sauvegarde trouv√©e.");
                return;
            }
            
            const data = JSON.parse(savedData);
            
            // 1. Restaurer l'image
            if (data.image) {
                const img = document.getElementById('user-map-img');
                img.src = data.image;
                img.classList.remove('hidden');
                document.getElementById('placeholder-text').classList.add('hidden');
            }
            
            // 2. Nettoyer le plateau actuel
            placedItems = [];
            document.getElementById('drop-zone').innerHTML = '';
            
            // 3. Restaurer les items
            data.items.forEach(item => {
                restoreItem(item);
            });
            
            showToast("üìÇ", "Carte restaur√©e !");
            updateProgress(0); // Recalculer le score si besoin
        }

        function restoreItem(itemData) {
            const dropZone = document.getElementById('drop-zone');
            const el = document.createElement('div');
            el.className = 'draggable pointer-events-auto';
            el.style.left = itemData.left;
            el.style.top = itemData.top;
            
            // Reconstruit l'objet item complet pour le tableau placedItems
            const itemObj = { label: itemData.label, type: itemData.type, icon: itemData.icon, el: el };
            placedItems.push(itemObj);
            
            let borderColor = "#334155";
            if(itemData.type === 'admin') borderColor = "#2563eb";
            if(itemData.type === 'frein') borderColor = "#dc2626";
            if(itemData.type === 'moyen') borderColor = "#16a34a";

            el.innerHTML = `<div class="icon-content shadow-sm" style="border-color:${borderColor}"><span class="text-lg leading-none">${itemData.icon}</span><span class="text-[7px] font-bold uppercase mt-0.5 leading-none text-slate-800">${itemData.label}</span></div><button class="absolute -top-1.5 -right-1.5 bg-slate-800 text-white rounded-full w-3.5 h-3.5 flex items-center justify-center text-[8px] font-bold border border-white shadow-sm z-50" onmousedown="event.stopPropagation(); removeItem(this, '${itemData.label}')">√ó</button>`;
            
            enableDrag(el);
            dropZone.appendChild(el);
        }

        // UI LOGIC
        window.addEventListener('load', () => renderAllTools());

        function switchTab(id) {
            document.querySelectorAll('.v-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.tools-grid').forEach(g => g.classList.add('hidden'));
            document.getElementById('content-'+id).classList.remove('hidden');
        }

        function renderAllTools() {
            const taxonomy = {
                lieux: [ { icon: "üè†", label: "Maison", type: "default" }, { icon: "üè¢", label: "Milo", type: "default" }, { icon: "üíº", label: "Job", type: "default" }, { icon: "üéì", label: "√âcole", type: "default" }, { icon: "üè•", label: "Sant√©", type: "default" }, { icon: "üõí", label: "Shop", type: "default" } ],
                moyens: [ { icon: "üëü", label: "Pied", type: "moyen" }, { icon: "üö≤", label: "V√©lo", type: "moyen" }, { icon: "üöå", label: "Bus", type: "moyen" }, { icon: "üöó", label: "Auto", type: "moyen" }, { icon: "üöê", label: "Covoit", type: "moyen" } ],
                admin: [ { icon: "üö¶", label: "Code", type: "admin" }, { icon: "üÖøÔ∏è", label: "Permis", type: "admin" }, { icon: "üî¢", label: "NEPH", type: "admin" }, { icon: "üéüÔ∏è", label: "Tarif", type: "admin" } ],
                freins: [ { icon: "üí∏", label: "Cher", type: "frein" }, { icon: "üò®", label: "Peur", type: "frein" }, { icon: "‚è≥", label: "Long", type: "frein" }, { icon: "üåë", label: "Nuit", type: "frein" } ],
                horizons: [ { icon: "‚úàÔ∏è", label: "Voyage", type: "horizon" }, { icon: "üá™üá∫", label: "Erasmus", type: "horizon" } ]
            };

            for (const [cat, items] of Object.entries(taxonomy)) {
                const container = document.getElementById(`content-${cat}`);
                items.forEach(item => {
                    const div = document.createElement('div');
                    let typeClass = "";
                    if(item.type === 'admin') typeClass = "type-admin";
                    if(item.type === 'frein') typeClass = "type-frein";
                    if(item.type === 'moyen') typeClass = "type-moyen";
                    if(item.type === 'horizon') typeClass = "type-horizon";
                    
                    div.className = `tool-item ${typeClass}`;
                    div.innerHTML = `<span class="text-xl leading-none mb-1">${item.icon}</span><span class="text-[8px] font-bold uppercase text-slate-700 truncate w-full text-center">${item.label}</span>`;
                    div.onclick = () => addToMap(item);
                    container.appendChild(div);
                });
            }
        }

        function handleMapUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('user-map-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('placeholder-text').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function addToMap(item) {
            const dropZone = document.getElementById('drop-zone');
            const el = document.createElement('div');
            el.className = 'draggable pointer-events-auto';
            el.style.left = '50%'; el.style.top = '50%';
            
            // Important : stocker la r√©f de l'√©l√©ment pour la sauvegarde
            const itemObj = { ...item, el: el };
            placedItems.push(itemObj);
            
            let borderColor = "#334155";
            if(item.type === 'admin') borderColor = "#2563eb";
            if(item.type === 'frein') borderColor = "#dc2626";
            if(item.type === 'moyen') borderColor = "#16a34a";

            el.innerHTML = `<div class="icon-content shadow-sm" style="border-color:${borderColor}"><span class="text-lg leading-none">${item.icon}</span><span class="text-[7px] font-bold uppercase mt-0.5 leading-none text-slate-800">${item.label}</span></div><button class="absolute -top-1.5 -right-1.5 bg-slate-800 text-white rounded-full w-3.5 h-3.5 flex items-center justify-center text-[8px] font-bold border border-white shadow-sm z-50" onmousedown="event.stopPropagation(); removeItem(this, '${item.label}')">√ó</button>`;
            enableDrag(el);
            dropZone.appendChild(el);
            updateProgress(1);
        }

        function removeItem(btn, label) {
            btn.parentElement.remove();
            const index = placedItems.findIndex(i => i.label === label);
            if (index > -1) placedItems.splice(index, 1);
            updateProgress(-1);
        }

        function addZone(size, bg, border, label) {
            const dropZone = document.getElementById('drop-zone');
            const zone = document.createElement('div');
            zone.className = 'circle-zone group';
            zone.style.width = size + 'px'; zone.style.height = size + 'px';
            zone.style.left = '50%'; zone.style.top = '50%';
            zone.style.backgroundColor = bg; zone.style.borderColor = border;
            
            // Pour les zones, on ne les sauvegarde pas dans placedItems dans cette version simple,
            // mais on pourrait l'ajouter si besoin.
            
            zone.innerHTML = `<span class="text-[8px] font-bold text-slate-700 bg-white/90 px-1.5 py-0.5 rounded absolute top-2 border border-slate-200 shadow-sm pointer-events-none select-none whitespace-nowrap">${label}</span><button class="absolute -top-2 -right-2 w-4 h-4 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold border border-white shadow-sm pointer-events-auto z-30 text-[8px]" onmousedown="event.stopPropagation(); this.parentElement.remove();">√ó</button><div class="absolute w-8 h-8 bg-white/30 rounded-full pointer-events-auto flex items-center justify-center cursor-move text-[10px] text-slate-700 z-10 hover:bg-white/50">‚ú•</div>`;
            enableDrag(zone, zone.querySelector('.cursor-move'));
            dropZone.appendChild(zone);
            updateProgress(1);
        }

        function enableDrag(el, handle = null) {
            let isDragging = false, startX, startY, initialLeft, initialTop;
            const target = handle || el;
            
            function onStart(e) {
                if(e.target.tagName === 'BUTTON') return;
                e.stopPropagation(); 
                isDragging = true; 
                el.style.zIndex = 2000;
                
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                startX = cx; 
                startY = cy;
                initialLeft = parseFloat(el.style.left) || 50; 
                initialTop = parseFloat(el.style.top) || 50;
                
                document.addEventListener('mousemove', onMove, { passive: false });
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd); 
                document.addEventListener('touchend', onEnd);
            }

            function onMove(e) {
                if(!isDragging) return; 
                e.preventDefault();
                
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                
                // On r√©cup√®re le rectangle de la zone de d√©p√¥t. 
                // Comme elle est dans un conteneur zoom√©, getBoundingClientRect() renvoie la taille visuelle (zoom√©e).
                const rect = document.getElementById('drop-zone').getBoundingClientRect();
                
                // Le d√©placement doit √™tre calcul√© relativement √† la taille VISUELLE pour que le pourcentage soit correct.
                // Donc la formule standard fonctionne m√™me avec le zoom !
                let nl = initialLeft + ((cx - startX) / rect.width) * 100;
                let nt = initialTop + ((cy - startY) / rect.height) * 100;
                
                el.style.left = nl + '%';
                el.style.top = nt + '%';
            }

            function onEnd() {
                isDragging = false; 
                el.style.zIndex = 1000; 
                document.removeEventListener('mousemove', onMove); 
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd); 
                document.removeEventListener('touchend', onEnd);
            }

            target.addEventListener('mousedown', onStart); 
            target.addEventListener('touchstart', onStart, { passive: false });
        }

        let progress = 0;
        function updateProgress(delta) {
            progress = Math.max(0, Math.min(10, progress + delta));
            let pct = progress * 10;
            document.getElementById('progress-bar').style.height = pct + '%';
            document.getElementById('progress-text').innerText = pct + '%';
        }

        // IA Functions
        function toggleChat() { document.getElementById('chat-overlay').classList.toggle('hidden'); }
        function handleChatKey(e) { if(e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('chat-input'); const msg = input.value.trim(); if(!msg) return;
            addMsg(msg, 'user'); input.value = '';
            addMsg("...", 'ai', true);
            const res = await callGemini(msg);
            document.querySelector('.animate-pulse').parentElement.remove();
            addMsg(res, 'ai');
        }
        function addMsg(txt, sender, load=false) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${sender === 'user' ? 'chat-user' : 'chat-ai'}`;
            if(load) div.innerHTML = '<span class="animate-pulse">...</span>';
            else if(sender === 'ai') div.innerHTML = marked.parse(txt);
            else div.innerText = txt;
            document.getElementById('chat-messages').appendChild(div);
        }
        async function analyzeMapWithAI() {
             if(placedItems.length === 0) return alert("Carte vide !");
             toggleChat(); addMsg("Analyse en cours...", 'ai');
             const prompt = `Analyse cette carte : ${placedItems.map(i=>i.label).join(', ')}. Donne 1 conseil court.`;
             const res = await callGemini(prompt);
             addMsg(res, 'ai');
        }
        async function callGemini(msg) {
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             const body = { contents: [{ parts: [{ text: msg }] }], systemInstruction: { parts: [{ text: contextPrompt }] } };
             try { const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); const d = await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur"; } catch(e) { return "Erreur"; }
        }
        function openRoadbook() {
            const w = window.open('','_blank'); w.document.write('<html><body style="text-align:center;padding:50px;font-family:sans-serif;"><h1>Roadbook</h1><p>Capturez votre carte !</p><button onclick="window.print()">Imprimer</button></body></html>');
        }
        
        function showToast(icon, msg) {
            const t = document.getElementById('toast-message');
            t.innerHTML = `<span>${icon}</span> <span>${msg}</span>`;
            t.classList.remove('hidden'); t.style.opacity = 1;
            setTimeout(() => { t.style.opacity = 0; setTimeout(() => t.classList.add('hidden'), 300); }, 1500);
        }
    </script>
</body>
</html>
