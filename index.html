<!doctype html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map Ta Mobilit√© - Pays Basque</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* BASE */
        :root { --primary: #2563eb; --dark: #0f172a; }
        * { font-family: 'Montserrat', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; background-color: #f8fafc; }

        /* CARTE */
        #map-container { position: relative; z-index: 1; height: 100%; width: 100%; }
        #leaflet-map { width: 100%; height: 100%; z-index: 0; background: #cbd5e1; }

        /* ICONS SUR LA CARTE */
        .draggable {
            position: absolute; z-index: 1000; cursor: grab;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }
        .draggable:active { cursor: grabbing; transform: scale(1.1) translate(-50%, -50%); }

        .icon-content {
            background: white; border: 2px solid var(--dark); border-radius: 12px;
            padding: 4px 8px; display: flex; flex-direction: column; align-items: center;
            min-width: 64px; text-align: center;
        }

        /* ICONS DANS LA SIDEBAR */
        .dock-item {
            background: white; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.1s ease; border: 1px solid #e2e8f0; cursor: pointer;
        }
        .dock-item:hover { transform: translateY(-2px); border-color: #94a3b8; }
        .dock-item:active { transform: scale(0.95); background-color: #f1f5f9; }

        /* COULEURS */
        .icon-type-admin { border-color: #3b82f6; background: #eff6ff; color: #1e40af; } 
        .icon-type-frein { border-color: #ef4444; background: #fef2f2; color: #991b1b; } 
        .icon-type-moyen { border-color: #22c55e; background: #f0fdf4; color: #166534; } 
        .icon-type-horizon { border-color: #a855f7; background: #faf5ff; color: #6b21a8; } 
        .icon-type-default { border-color: #94a3b8; background: #ffffff; color: #334155; }

        /* ZONES */
        .circle-zone {
            position: absolute; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; pointer-events: none; border: 2px dashed; z-index: 100;
        }

        /* TABS NAVIGATION */
        .tab-btn {
            display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 8px;
            color: #64748b; transition: all 0.2s; padding: 10px; border-radius: 8px;
            font-weight: 700; font-size: 11px; text-transform: uppercase;
        }
        .tab-btn.active { background-color: #f1f5f9; color: var(--dark); box-shadow: inset 0 0 0 1px #e2e8f0; }
        .tab-icon { font-size: 18px; }

        /* TOOLTIP */
        #custom-tooltip {
            pointer-events: none; position: fixed; z-index: 9999; opacity: 0;
            transition: opacity 0.15s ease; transform: translate(-50%, -100%); margin-top: -12px;
        }
        #custom-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: #0f172a transparent transparent transparent;
        }

        /* PROGRESS BAR */
        .progress-fill { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); background: linear-gradient(90deg, #3b82f6 0%, #facc15 100%); }

        /* MODAL */
        #help-modal.hidden { pointer-events: none; opacity: 0; }
        #help-modal:not(.hidden) { opacity: 1; pointer-events: auto; }

        /* MEDIA QUERY POUR LAYOUT MOBILE vs BUREAU */
        @media (max-width: 768px) {
            .tab-btn { flex-direction: column; gap: 2px; font-size: 9px; }
            .sidebar-title { display: none; }
        }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden text-slate-800 bg-slate-50">

    <!-- TOOLTIP -->
    <div id="custom-tooltip" class="bg-slate-900 text-white text-[11px] font-medium px-4 py-2 rounded-xl shadow-xl max-w-[200px] text-center leading-snug"></div>

    <!-- MODAL AIDE -->
    <div id="help-modal" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900/60 backdrop-blur-md hidden px-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
            <div class="bg-slate-900 p-4 text-white flex justify-between items-center">
                <h2 class="font-bold text-lg uppercase">Guide Rapide</h2>
                <button onclick="toggleHelp()" class="text-white hover:text-gray-300">‚úï</button>
            </div>
            <div class="p-6">
                <ul class="text-sm space-y-4">
                    <li>1. <strong>Choisis une cat√©gorie</strong> dans le menu de gauche.</li>
                    <li>2. <strong>Clique sur un picto</strong> pour le faire appara√Ætre.</li>
                    <li>3. <strong>Glisse-le</strong> sur la carte.</li>
                </ul>
                <div class="mt-6 text-center">
                    <button onclick="toggleHelp()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">OK !</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER (Barre fine en haut) -->
    <header class="bg-white border-b border-slate-200 px-4 h-14 flex justify-between items-center z-20 shrink-0 shadow-sm relative">
        <div class="flex items-center gap-3">
            <img src="https://static.wixstatic.com/media/dd5dab_7e61f61a3fab4046946b861015ab0f2d~mv2.avif/v1/fill/w_124,h_59,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/Design%20sans%20titre.avif" 
                 alt="Logo" class="h-8 w-auto object-contain">
            <div class="h-6 w-px bg-slate-200 mx-2 hidden md:block"></div>
            <h1 class="font-black text-lg uppercase text-slate-900 tracking-tight leading-none">
                MAP TA <span class="text-blue-600">MOBILIT√â</span>
            </h1>
        </div>
        
        <!-- Barre de progression int√©gr√©e au header sur Desktop -->
        <div class="hidden md:flex flex-col w-64 mx-4">
            <div class="flex justify-between items-end mb-1">
                <span class="text-[9px] font-bold uppercase text-slate-400">Progression</span>
                <span id="progress-text" class="text-[10px] font-black text-blue-600">0%</span>
            </div>
            <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                <div id="progress-bar" class="progress-fill h-full w-0 rounded-full"></div>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="toggleHelp()" class="hidden md:flex bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 text-xs font-bold rounded-lg transition-colors items-center gap-2">
                <span>üí°</span> Aide
            </button>
            <button onclick="openRoadbook()" class="bg-yellow-400 hover:bg-yellow-300 text-slate-900 px-4 py-2 text-xs font-black rounded-lg shadow-sm border border-yellow-500 uppercase tracking-wide transition-all active:scale-95 flex items-center gap-2">
                <span>üíæ</span> Sauvegarder
            </button>
        </div>
    </header>

    <!-- BARRE PROG (Mobile seulement) -->
    <div class="md:hidden bg-white px-4 py-2 z-10 border-b border-slate-100">
        <div class="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden">
            <div id="progress-bar-mobile" class="progress-fill h-full w-0 rounded-full bg-blue-600"></div>
        </div>
    </div>

    <!-- MAIN CONTAINER (Layout Flexible : Colonne sur mobile, Ligne sur Desktop) -->
    <div class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR GAUCHE (Outils) - RATIO 1/3 -->
        <!-- Sur mobile: en bas (order-2). Sur desktop: √† gauche (order-1) -->
        <aside class="order-2 md:order-1 w-full md:w-1/3 bg-white border-t md:border-t-0 md:border-r border-slate-200 flex flex-col shadow-xl z-30">
            
            <!-- Navigation des onglets -->
            <nav class="flex md:grid md:grid-cols-3 md:gap-2 p-2 border-b border-slate-100 bg-white overflow-x-auto md:overflow-visible">
                <button onclick="switchTab('lieux')" id="tab-lieux" class="flex-1 tab-btn active group">
                    <span class="tab-icon">üè†</span><span class="tab-label">Lieux</span>
                </button>
                <button onclick="switchTab('moyens')" id="tab-moyens" class="flex-1 tab-btn group">
                    <span class="tab-icon">üöå</span><span class="tab-label">Transports</span>
                </button>
                <button onclick="switchTab('admin')" id="tab-admin" class="flex-1 tab-btn group">
                    <span class="tab-icon">üÜî</span><span class="tab-label">Papiers</span>
                </button>
                <button onclick="switchTab('freins')" id="tab-freins" class="flex-1 tab-btn group">
                    <span class="tab-icon">üöß</span><span class="tab-label">√áa bloque</span>
                </button>
                <button onclick="switchTab('horizons')" id="tab-horizons" class="flex-1 tab-btn group">
                    <span class="tab-icon">üåç</span><span class="tab-label">Horizons</span>
                </button>
                <button onclick="switchTab('zones')" id="tab-zones" class="flex-1 tab-btn group bg-slate-50">
                    <span class="tab-icon">‚≠ï</span><span class="tab-label">Zones</span>
                </button>
            </nav>

            <!-- Zone de contenu scrollable -->
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50/50 custom-scrollbar relative h-48 md:h-auto">
                <div id="content-lieux" class="grid grid-cols-4 md:grid-cols-3 gap-3 content-start"></div>
                <div id="content-moyens" class="hidden grid grid-cols-4 md:grid-cols-3 gap-3 content-start"></div>
                <div id="content-admin" class="hidden grid grid-cols-4 md:grid-cols-3 gap-3 content-start"></div>
                <div id="content-freins" class="hidden grid grid-cols-4 md:grid-cols-3 gap-3 content-start"></div>
                <div id="content-horizons" class="hidden grid grid-cols-4 md:grid-cols-3 gap-3 content-start"></div>
                
                <!-- ZONES (Liste Verticale) -->
                <div id="content-zones" class="hidden flex flex-col gap-3">
                    <p class="text-xs text-center text-slate-400 font-bold uppercase mb-2">D√©finis tes territoires</p>
                    <button onclick="addZone(200, 'rgba(34, 197, 94, 0.15)', '#16a34a', 'Zone CONFORT')" 
                            class="w-full py-3 rounded-lg border-2 border-green-500 bg-white text-green-700 font-bold flex items-center justify-between px-4 shadow-sm hover:bg-green-50 transition-colors">
                        <div class="flex items-center gap-3"><span class="text-xl">üòé</span> <span class="text-xs">MA ZONE CONFORT</span></div>
                        <span class="text-lg">+</span>
                    </button>
                    <button onclick="addZone(500, 'rgba(234, 179, 8, 0.15)', '#ca8a04', 'Zone EFFORT')" 
                            class="w-full py-3 rounded-lg border-2 border-yellow-500 bg-white text-yellow-700 font-bold flex items-center justify-between px-4 shadow-sm hover:bg-yellow-50 transition-colors">
                        <div class="flex items-center gap-3"><span class="text-xl">ü§î</span> <span class="text-xs">MA ZONE EFFORT</span></div>
                        <span class="text-lg">+</span>
                    </button>
                    <button onclick="addZone(1000, 'rgba(239, 68, 68, 0.15)', '#ef4444', 'Zone GAL√àRE')" 
                            class="w-full py-3 rounded-lg border-2 border-red-500 bg-white text-red-700 font-bold flex items-center justify-between px-4 shadow-sm hover:bg-red-50 transition-colors">
                        <div class="flex items-center gap-3"><span class="text-xl">üö´</span> <span class="text-xs">MA ZONE GAL√àRE</span></div>
                        <span class="text-lg">+</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- CARTE (Droite) - RATIO 2/3 (Flex-1 prend le reste) -->
        <div id="map-container" class="order-1 md:order-2 flex-1 relative h-full">
            <div id="leaflet-map"></div>
            
            <!-- Controle Reseau -->
            <button onclick="toggleNetwork()" id="btn-network" class="absolute top-4 right-4 bg-white/90 backdrop-blur text-slate-800 px-4 py-2 text-[11px] font-bold rounded-full shadow-lg border border-white/50 z-[500] flex items-center gap-2 active:scale-95 transition-all hover:shadow-xl group">
                <span class="w-2.5 h-2.5 rounded-full bg-slate-300 group-hover:bg-green-500 transition-colors" id="network-indicator"></span>
                R√©seau Txik Txak
            </button>

            <div id="drop-zone" class="absolute inset-0 z-10 pointer-events-none"></div>
            <div id="toast-message" class="absolute top-16 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-4 py-2 rounded-full shadow-xl z-50 text-[11px] font-bold hidden transition-opacity flex items-center gap-2 pointer-events-none"></div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // CONFIGURATION DONN√âES
        const taxonomy = {
            lieux: [
                { icon: "üè†", label: "Maison", type: "default", desc: "Ta base. L√† o√π tu dors." },
                { icon: "üè¢", label: "Mission Loc.", type: "default", desc: "Ton point de rendez-vous avec ton conseiller." },
                { icon: "üíº", label: "Job / Stage", type: "default", desc: "L'endroit o√π tu travailles." },
                { icon: "üéì", label: "Formation", type: "default", desc: "Ton √©cole ou centre de formation." },
                { icon: "üë™", label: "Famille", type: "default", desc: "Chez tes parents ou ta famille." },
                { icon: "ü§ù", label: "Potes", type: "default", desc: "Le QG o√π tu retrouves tes amis." },
                { icon: "üè•", label: "Sant√©", type: "default", desc: "M√©decin, h√¥pital." },
                { icon: "üõí", label: "Courses", type: "default", desc: "Supermarch√©." }
            ],
            moyens: [
                { icon: "üëü", label: "A Pied", type: "moyen", desc: "Marche √† pied." },
                { icon: "üö≤", label: "V√©lo", type: "moyen", desc: "V√©lo perso / √©lec." },
                { icon: "üöå", label: "Bus", type: "moyen", desc: "Txik Txak / Car." },
                { icon: "üöê", label: "Covoit'", type: "moyen", desc: "Covoiturage." },
                { icon: "üõµ", label: "Scooter", type: "moyen", desc: "Deux-roues." },
                { icon: "üöó", label: "Passager", type: "moyen", desc: "On te d√©pose." },
                { icon: "üöò", label: "Voiture", type: "moyen", desc: "Tu conduis." },
                { icon: "üöÜ", label: "Train", type: "moyen", desc: "Gare / TER." }
            ],
            admin: [
                { icon: "üö¶", label: "Code OK", type: "admin", desc: "Code valid√©." },
                { icon: "üìö", label: "Code", type: "admin", desc: "En r√©vision." },
                { icon: "üî¢", label: "NEPH", type: "admin", desc: "Num√©ro permis." },
                { icon: "üÖøÔ∏è", label: "Permis B", type: "admin", desc: "Permis voiture." },
                { icon: "üÜî", label: "C.I.", type: "admin", desc: "Carte identit√©." },
                { icon: "üéüÔ∏è", label: "Solidair.", type: "admin", desc: "Carte Transport." },
                { icon: "üëÆ", label: "BSR", type: "admin", desc: "Permis AM." },
                { icon: "üí∂", label: "Aide", type: "admin", desc: "Aide financi√®re." }
            ],
            freins: [
                { icon: "üí∏", label: "Cher", type: "frein", desc: "Co√ªt trop √©lev√©." },
                { icon: "üò®", label: "Peur", type: "frein", desc: "Stress / Ins√©curit√©." },
                { icon: "‚è≥", label: "Long", type: "frein", desc: "Trajet trop long." },
                { icon: "üåë", label: "Horaires", type: "frein", desc: "Pas de bus." },
                { icon: "üß≠", label: "Perdu", type: "frein", desc: "Je connais pas." },
                { icon: "‚ùå", label: "Aucun", type: "frein", desc: "Zone blanche." },
                { icon: "üìÖ", label: "Organis.", type: "frein", desc: "Planning dur." },
                { icon: "üèöÔ∏è", label: "Loin", type: "frein", desc: "Trop de km." }
            ],
            horizons: [
                { icon: "‚úàÔ∏è", label: "Voyage", type: "horizon", desc: "Vacances." },
                { icon: "üá™üá∫", label: "Erasmus", type: "horizon", desc: "Europe." },
                { icon: "üéí", label: "Stage", type: "horizon", desc: "Stage √©tranger." },
                { icon: "üå¥", label: "R√™ve", type: "horizon", desc: "Destination top." },
                { icon: "üá´üá∑", label: "France", type: "horizon", desc: "Ailleurs FR." },
                { icon: "üíº", label: "Saison", type: "horizon", desc: "Job saisonnier." },
                { icon: "ü§ù", label: "Volont.", type: "horizon", desc: "Service Civique." },
                { icon: "üì¶", label: "D√©m√©nag.", type: "horizon", desc: "Nouveau logement." }
            ]
        };

        const mainCities = [
            { name: "BAYONNE", loc: [43.4929, -1.4748] },
            { name: "HENDAYE", loc: [43.3600, -1.7740] },
            { name: "TARDETS", loc: [43.1100, -0.8600] }, // Point Est
            { name: "ST-JEAN-P-P", loc: [43.1636, -1.2374] }, // Point Sud
            { name: "MAULEON", loc: [43.2234, -0.8906] },
            { name: "ST-PALAIS", loc: [43.3283, -1.0333] }
        ];

        let map;
        let networkLayer; 
        let isNetworkVisible = false;
        let progressCount = 0; 
        
        const HORIZONS_CENTER = [46.2, 2.2]; 
        const HORIZONS_ZOOM = 5;
        let basqueBounds;

        window.addEventListener('load', () => {
            initMap();
            renderAllTools();
            initNetworkLayer();
        });

        function initMap() {
            map = L.map('leaflet-map', {
                zoomControl: false, attributionControl: false,
                minZoom: 3, zoomSnap: 0.5
            });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

            const latLngs = mainCities.map(city => city.loc);
            basqueBounds = L.latLngBounds(latLngs);
            // Padding pour s'assurer que tout le PB est visible
            map.fitBounds(basqueBounds, { padding: [50, 50] });

            setTimeout(() => map.invalidateSize(), 500);
        }

        // TOOLTIPS & UI
        const tooltip = document.getElementById('custom-tooltip');
        function showTooltip(e, text) {
            tooltip.innerText = text; tooltip.style.opacity = '1';
            tooltip.style.left = e.clientX + 'px'; tooltip.style.top = (e.clientY - 15) + 'px';
            document.addEventListener('mousemove', moveTooltip);
        }
        function moveTooltip(e) {
            tooltip.style.left = e.clientX + 'px'; tooltip.style.top = (e.clientY - 15) + 'px';
        }
        function hideTooltip() {
            tooltip.style.opacity = '0';
            document.removeEventListener('mousemove', moveTooltip);
        }

        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            modal.classList.toggle('hidden');
        }

        // RESEAU TXIK TXAK
        function initNetworkLayer() {
            const t1 = L.polyline([[43.5042, -1.4552], [43.4933, -1.4751], [43.4812, -1.5150], [43.4750, -1.5580]], { color: '#e11d48', weight: 4 });
            const t2 = L.polyline([[43.5200, -1.4650], [43.4933, -1.4751], [43.4800, -1.4850], [43.4650, -1.5050]], { color: '#16a34a', weight: 4 });
            // Ligne fictive pour mailler l'int√©rieur
            const interieur = L.polyline([[43.4933, -1.4751], [43.3280, -1.0330], [43.2200, -0.8900]], { color: '#9333ea', weight: 3 });
            networkLayer = L.layerGroup([t1, t2, interieur]);
        }
        
        function toggleNetwork() {
            const indicator = document.getElementById('network-indicator');
            if (isNetworkVisible) {
                map.removeLayer(networkLayer); isNetworkVisible = false;
                indicator.classList.replace('bg-green-500', 'bg-slate-300');
            } else {
                map.addLayer(networkLayer); isNetworkVisible = true;
                indicator.classList.replace('bg-slate-300', 'bg-green-500');
                showToast("üöå", "R√©seau affich√©");
            }
        }

        // RENDU TOOLS
        function renderAllTools() {
            renderSection('lieux', taxonomy.lieux);
            renderSection('moyens', taxonomy.moyens);
            renderSection('admin', taxonomy.admin);
            renderSection('freins', taxonomy.freins);
            renderSection('horizons', taxonomy.horizons);
        }

        function renderSection(id, items) {
            const container = document.getElementById(`content-${id}`);
            items.forEach(item => {
                const btn = document.createElement('div');
                let typeClass = "icon-type-default";
                if(item.type === 'admin') typeClass = "icon-type-admin";
                if(item.type === 'frein') typeClass = "icon-type-frein";
                if(item.type === 'moyen') typeClass = "icon-type-moyen";
                if(item.type === 'horizon') typeClass = "icon-type-horizon";

                btn.className = `dock-item flex flex-col items-center justify-center p-2 h-[80px] w-full ${typeClass} bg-opacity-20 border-opacity-60`;
                // Pour le dock, on garde le fond blanc mais la bordure color√©e
                btn.style.backgroundColor = "white";

                btn.innerHTML = `
                    <span class="text-2xl mb-1 filter drop-shadow-sm">${item.icon}</span>
                    <span class="text-[9px] font-bold uppercase text-slate-700 truncate w-full text-center leading-tight">${item.label}</span>
                `;
                btn.onmouseenter = (e) => showTooltip(e, item.desc);
                btn.onmouseleave = hideTooltip;
                btn.onclick = () => addToMap(item);
                container.appendChild(btn);
            });
        }

        // NAVIGATION
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            ['lieux', 'moyens', 'admin', 'freins', 'horizons', 'zones'].forEach(id => {
                document.getElementById(`content-${id}`).classList.add('hidden');
                document.getElementById(`content-${id}`).classList.remove('grid', 'flex');
            });
            
            const content = document.getElementById(`content-${tabId}`);
            content.classList.remove('hidden');
            if(tabId === 'zones') content.classList.add('flex'); else content.classList.add('grid');

            if (tabId === 'horizons') map.flyTo(HORIZONS_CENTER, HORIZONS_ZOOM, { duration: 1.5 });
            else if (basqueBounds) map.fitBounds(basqueBounds, { padding: [30, 30], duration: 1.5 });
        }

        // LOGIQUE AJOUT
        function addToMap(item) {
            const dropZone = document.getElementById('drop-zone');
            const el = document.createElement('div');
            el.className = 'draggable pointer-events-auto';
            el.style.left = '50%'; el.style.top = '50%';
            
            let typeClass = "";
            if(item.type === 'admin') typeClass = "icon-type-admin";
            if(item.type === 'frein') typeClass = "icon-type-frein";
            if(item.type === 'moyen') typeClass = "icon-type-moyen";
            if(item.type === 'horizon') typeClass = "icon-type-horizon";

            el.innerHTML = `
                <div class="icon-content shadow-lg ${typeClass}">
                    <span class="text-2xl">${item.icon}</span>
                    <span class="text-[8px] font-bold uppercase mt-1 leading-none text-slate-800">${item.label}</span>
                </div>
                <button class="absolute -top-2 -right-2 bg-slate-800 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] font-bold border-2 border-white shadow-md z-50 hover:bg-red-500 transition-colors hover:scale-110"
                        ontouchstart="event.stopPropagation(); this.parentElement.remove();"
                        onmousedown="event.stopPropagation(); this.parentElement.remove();">‚úï</button>
            `;
            el.onmouseenter = (e) => showTooltip(e, item.desc);
            el.onmouseleave = hideTooltip;

            enableDrag(el);
            dropZone.appendChild(el);
            updateProgress();
            showToast(item.icon, "Ajout√©");
        }

        function addZone(sizePx, colorBg, colorBorder, label) {
            const dropZone = document.getElementById('drop-zone');
            const zone = document.createElement('div');
            zone.className = 'circle-zone group';
            let currentSize = sizePx || 150;
            zone.style.width = currentSize + 'px'; zone.style.height = currentSize + 'px';
            zone.style.left = '50%'; zone.style.top = '50%';
            zone.style.transform = 'translate(-50%, -50%)';
            zone.style.backgroundColor = colorBg; zone.style.borderColor = colorBorder;

            zone.innerHTML = `
                <span class="text-[9px] font-bold text-slate-700 bg-white/95 px-2 py-0.5 rounded-full absolute top-2 border border-slate-200 shadow-sm whitespace-nowrap z-20 pointer-events-none select-none">${label}</span>
                <button class="absolute -top-3 -right-3 w-6 h-6 bg-slate-900 text-white rounded-full flex items-center justify-center font-bold border-2 border-white shadow-md pointer-events-auto hover:bg-red-600 z-30 touch-manipulation"
                    ontouchstart="event.stopPropagation(); this.parentElement.remove();"
                    onmousedown="event.stopPropagation(); this.parentElement.remove();">‚úï</button>
                <div class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 pointer-events-auto z-30">
                    <button class="w-8 h-8 bg-white text-slate-900 rounded-full flex items-center justify-center font-bold border border-slate-200 shadow hover:bg-slate-50 touch-manipulation text-lg" 
                        onmousedown="event.stopPropagation(); resizeZone(this, -30)">-</button>
                    <button class="w-8 h-8 bg-white text-slate-900 rounded-full flex items-center justify-center font-bold border border-slate-200 shadow hover:bg-slate-50 touch-manipulation text-lg" 
                        onmousedown="event.stopPropagation(); resizeZone(this, 30)">+</button>
                </div>
                <div class="absolute w-10 h-10 bg-white/40 rounded-full border-2 border-slate-900/20 pointer-events-auto flex items-center justify-center cursor-move text-xs text-slate-700 z-10 hover:bg-white/60">‚ú•</div>
            `;
            const handle = zone.querySelector('.cursor-move');
            enableDrag(zone, handle);
            dropZone.appendChild(zone);
            updateProgress();
        }

        function resizeZone(btn, delta) {
            const zone = btn.closest('.circle-zone');
            let size = parseInt(zone.style.width);
            let newSize = Math.max(50, size + delta);
            zone.style.width = newSize + 'px'; zone.style.height = newSize + 'px';
        }

        function enableDrag(el, handle = null) {
            let isDragging = false, startX, startY, initialLeft, initialTop;
            const target = handle || el;
            const container = document.getElementById('drop-zone');

            function onStart(e) {
                if(e.target.tagName === 'BUTTON') return;
                e.stopPropagation(); if(e.cancelable) e.preventDefault();
                isDragging = true; el.style.zIndex = 2000;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                startX = clientX; startY = clientY;
                initialLeft = parseFloat(el.style.left) || 50; initialTop = parseFloat(el.style.top) || 50;
                document.addEventListener('mousemove', onMove); document.addEventListener('touchmove', onMove, {passive: false});
                document.addEventListener('mouseup', onEnd); document.addEventListener('touchend', onEnd);
            }
            function onMove(e) {
                if (!isDragging) return; e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = container.getBoundingClientRect();
                el.style.left = (initialLeft + ((clientX - startX) / rect.width) * 100) + '%';
                el.style.top = (initialTop + ((clientY - startY) / rect.height) * 100) + '%';
            }
            function onEnd() {
                isDragging = false; el.style.zIndex = 1000;
                document.removeEventListener('mousemove', onMove); document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd); document.removeEventListener('touchend', onEnd);
            }
            target.addEventListener('mousedown', onStart); target.addEventListener('touchstart', onStart, { passive: false });
        }

        function updateProgress() {
            progressCount++;
            let percentage = Math.min((progressCount / 10) * 100, 100);
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').innerText = Math.round(percentage) + '%';
            if (document.getElementById('progress-bar-mobile')) document.getElementById('progress-bar-mobile').style.width = percentage + '%';
        }

        function showToast(icon, msg) {
            const toast = document.getElementById('toast-message');
            toast.innerHTML = `<span>${icon}</span> <span>${msg}</span>`;
            toast.classList.remove('hidden'); toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; setTimeout(() => toast.classList.add('hidden'), 300); }, 1500);
        }

        // ROADBOOK GENERATOR (Identique V12)
        function openRoadbook() {
            const roadbookWindow = window.open('', '_blank');
            if (!roadbookWindow) { alert("Veuillez autoriser les pop-ups."); return; }
            const htmlContent = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Roadbook</title><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet"><style>@page{margin:0}body{font-family:'Montserrat',sans-serif;margin:0;padding:20px}.container{max-width:210mm;margin:0 auto;border:4px solid black;padding:20px;height:290mm}header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:4px solid black;padding-bottom:20px;margin-bottom:20px}h1{font-size:42px;font-weight:900;text-transform:uppercase;margin:0}img{height:50px}.photo-zone{width:100%;height:240px;background:#f8fafc;border:2px dashed black;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:25px}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}.section{margin-bottom:15px}.section-title{font-weight:900;text-transform:uppercase}.check-item{display:flex;align-items:center;margin-bottom:6px;font-size:11px;font-weight:700}.checkbox{width:14px;height:14px;border:2px solid black;margin-right:8px}.footer{margin-top:auto;text-align:center;font-size:9px;font-weight:bold;text-transform:uppercase;color:#94a3b8}</style></head><body><div class="container"><header><div><img src="https://static.wixstatic.com/media/dd5dab_7e61f61a3fab4046946b861015ab0f2d~mv2.avif/v1/fill/w_124,h_59,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/Design%20sans%20titre.avif"></div><h1>Map ta<br>Mobilit√©</h1><div>DATE : ${new Date().toLocaleDateString('fr-FR')}</div></header><div class="photo-zone"><div>TA CARTE</div><div style="font-size:11px;background:black;color:white;padding:4px 10px;margin-top:10px">Colle ta capture ici</div></div><div class="grid-2"><div><div class="section"><div class="section-title">üè† MA ZONE</div><div class="check-item"><span class="checkbox"></span>Quartier</div><div class="check-item"><span class="checkbox"></span>Ville</div><div class="check-item"><span class="checkbox"></span>Pays Basque</div></div><div class="section"><div class="section-title">üÜî ADMIN</div><div class="check-item"><span class="checkbox"></span>Papiers OK</div><div class="check-item"><span class="checkbox"></span>Carte Solidaire</div><div class="check-item"><span class="checkbox"></span>NEPH</div></div></div><div><div class="section"><div class="section-title">üõë CA BLOQUE</div><div class="check-item"><span class="checkbox"></span>Budget</div><div class="check-item"><span class="checkbox"></span>Stress</div><div class="check-item"><span class="checkbox"></span>Horaires</div></div><div class="section"><div class="section-title">üåç HORIZONS</div><div class="check-item"><span class="checkbox"></span>Vacances</div><div class="check-item"><span class="checkbox"></span>Job Ailleurs</div></div></div></div><div style="border:4px solid black;padding:20px;background:#fffbeb;margin-top:20px"><div style="font-weight:800;margin-bottom:10px">MON OBJECTIF :</div><div style="border-bottom:2px solid black;height:30px;margin-bottom:10px"></div><div style="border-bottom:2px solid black;height:30px"></div></div><div class="footer">Mission Locale Pays Basque</div></div></body></html>`;
            roadbookWindow.document.write(htmlContent);
            roadbookWindow.document.close();
            setTimeout(() => { roadbookWindow.print(); }, 1000);
        }
    </script>
</body>
</html
