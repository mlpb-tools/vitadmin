<!doctype html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map Ta Mobilit√© - App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        * { font-family: 'Montserrat', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; background-color: #f8fafc; }

        header { height: 44px; }
        footer { height: 24px; font-size: 10px; }

        .cockpit-container { display: flex; height: calc(100vh - 68px); overflow: hidden; }

        /* SIDEBAR GAUCHE */
        .sidebar-left {
            width: 230px; background: white; border-right: 1px solid #cbd5e1;
            display: flex; flex-direction: row; z-index: 20; flex-shrink: 0;
        }

        .nav-column {
            width: 50px; background: #f1f5f9; border-right: 1px solid #e2e8f0;
            display: flex; flex-direction: column; align-items: center; padding-top: 10px;
            overflow-y: auto; flex-shrink: 0;
        }

        .nav-btn {
            width: 100%; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #64748b; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; margin-bottom: 4px;
        }
        .nav-btn:hover { background: #e2e8f0; color: #334155; }
        .nav-btn.active {
            background: white; color: #0f172a; border-left-color: #0f172a;
            box-shadow: -4px 0 0 white; width: 51px; z-index: 10;
        }
        .nav-icon { font-size: 22px; margin-bottom: 0px; }
        
        /* COLONNE OUTILS */
        .tools-column { flex: 1; background: white; display: flex; flex-direction: column; overflow: hidden; }
        
        .tools-header {
            padding: 12px 8px; border-bottom: 1px solid #f1f5f9;
            font-size: 9px; font-weight: 900; text-transform: uppercase;
            color: #64748b; text-align: center; letter-spacing: 0.05em;
            background: #f8fafc;
        }

        .tools-grid { padding: 8px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }

        .tool-item {
            display: flex; flex-direction: row; align-items: center; justify-content: flex-start;
            border: 1px solid #e2e8f0; border-radius: 6px; padding: 6px 10px;
            cursor: pointer; transition: all 0.1s; background: white; min-height: 40px;
        }
        .tool-item:hover { transform: translateX(2px); border-color: #94a3b8; background: #f1f5f9; }

        /* CATEGORIES COULEURS */
        .type-lieu { border-left: 3px solid #64748b; }       
        .type-transport { border-left: 3px solid #f59e0b; }  
        .type-pro { border-left: 3px solid #0ea5e9; }        
        .type-admin { border-left: 3px solid #6366f1; }      
        .type-loisir { border-left: 3px solid #10b981; }     
        .type-frein { border-left: 3px solid #ef4444; }      

        /* MAP AREA - Format 3:2 */
        .map-stage {
            flex: 1; background-color: #e2e8f0;
            background-image: linear-gradient(45deg, #cbd5e1 25%, transparent 25%), linear-gradient(-45deg, #cbd5e1 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #cbd5e1 75%), linear-gradient(-45deg, transparent 75%, #cbd5e1 75%);
            background-size: 20px 20px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        
        #board-container {
            aspect-ratio: 3 / 2;
            height: 95%; width: auto; max-width: 95%;
            background: white; position: relative; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); 
            border: 2px solid white; border-radius: 8px; overflow: hidden; 
            display: flex; align-items: center; justify-content: center; 
        }
        @media (max-aspect-ratio: 3/2) {
            #board-container { width: 95%; height: auto; }
        }

        #map-transform-layer { width: 100%; height: 100%; position: relative; transform-origin: center center; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        #user-map-img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; z-index: 0; }

        /* STICKERS ET INPUTS */
        .draggable { position: absolute; z-index: 1000; cursor: grab; transform: translate(-50%, -50%); width: auto; height: auto; transition: transform 0.1s; display: flex; justify-content: center; }
        .draggable:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); z-index: 1500; }
        
        .icon-content { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .sticker-emoji { font-size: 26px; line-height: 1; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); margin-bottom: 2px; }
        
        .sticker-label { 
            font-size: 8px; font-weight: 800; text-transform: uppercase; color: #1e293b; 
            background-color: rgba(255, 255, 255, 0.85); padding: 2px 4px; border-radius: 4px; 
            margin-top: -4px; white-space: nowrap; backdrop-filter: blur(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.1); pointer-events: none;
        }

        .sticker-input {
            font-size: 9px; font-weight: 700; color: #1e293b; text-align: center;
            background-color: rgba(255, 255, 255, 0.95); 
            border: 1px solid #94a3b8; border-radius: 4px;
            padding: 2px 4px; width: 80px; margin-top: -2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            outline: none; transition: all 0.2s;
        }
        .sticker-input:focus { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); transform: scale(1.05); z-index: 2000; }
        .sticker-input::placeholder { color: #94a3b8; font-style: italic; font-weight: 400; }

        .delete-sticker-btn { position: absolute; top: -6px; right: -6px; width: 14px; height: 14px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; border: 1px solid white; opacity: 0; transition: opacity 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: 10; cursor: pointer; }
        .draggable:hover .delete-sticker-btn { opacity: 1; }

        /* BOUTON SUPPRESSION CARTE (BIBLIO) */
        .delete-map-btn { 
            position: absolute; top: 4px; right: 4px; width: 22px; height: 22px; 
            background: #ef4444; color: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; border: 2px solid white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; cursor: pointer; 
            transition: all 0.2s;
        }
        .delete-map-btn:hover { background: #dc2626; transform: scale(1.1); }

        /* SIDEBAR DROITE */
        .sidebar-right { width: 130px; background: white; border-left: 1px solid #cbd5e1; display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; align-items: center; padding-top: 10px; }
        .zone-btn { width: 90%; margin-bottom: 8px; padding: 8px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: white; border: 1px solid; font-size: 9px; font-weight: 800; text-transform: uppercase; }
        .v-progress-track { width: 8px; height: 100px; background: #e2e8f0; border-radius: 4px; margin: 20px 0; position: relative; overflow: hidden; }
        .v-progress-fill { width: 100%; background: #22c55e; position: absolute; bottom: 0; left: 0; transition: height 0.5s ease; }

        /* LIBRARY & CHAT */
        .library-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .library-modal.active { opacity: 1; pointer-events: auto; }
        .library-content { background: white; width: 90%; max-width: 600px; max-height: 80vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        
        .library-grid { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; overflow-y: auto; }
        
        .map-card { 
            border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden; cursor: pointer; 
            aspect-ratio: 1/1; position: relative; transition: transform 0.1s, box-shadow 0.1s; background: #f1f5f9;
        }
        .map-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }
        
        .map-preview { width: 100%; height: 100%; object-fit: cover; background: #f1f5f9; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 24px; }
        
        /* Design am√©lior√© des titres de cartes pour lisibilit√© */
        .map-title { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: #ffffff; /* Fond blanc opaque */
            padding: 6px 4px; 
            font-size: 11px; /* Un peu plus grand */
            font-weight: 700; 
            text-align: center; 
            color: #1e293b; /* Couleur sombre contrast√©e */
            border-top: 1px solid #e2e8f0;
            line-height: 1.2;
            white-space: normal;
            min-height: 40px; /* Hauteur suffisante */
            display: flex; align-items: center; justify-content: center;
            z-index: 20;
        }

        .chat-overlay { position: absolute; bottom: 10px; right: 10px; width: 280px; height: 350px; background: white; border: 1px solid #cbd5e1; border-radius: 8px; display: flex; flex-direction: column; z-index: 2000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .zoom-controls { position: absolute; bottom: 20px; left: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 500; }
        .zoom-btn { width: 32px; height: 32px; background: white; border: 1px solid #94a3b8; border-radius: 6px; font-weight: 900; color: #1e293b; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .circle-zone { position: absolute; border-radius: 50%; border: 2px dashed; pointer-events: none; transform: translate(-50%, -50%); z-index: 100; display:flex; justify-content:center; align-items:center;}

        @media (max-width: 768px) {
            .cockpit-container { flex-direction: column; }
            .sidebar-left { width: 100%; height: 35%; border-right: none; border-top: 1px solid #cbd5e1; flex-direction: row; order: 2; }
            .nav-column { width: 60px; }
            .sidebar-right { display: none; }
            .map-stage { height: 65%; order: 1; }
        }
    </style>
</head>
<body class="flex flex-col h-full overflow-hidden text-slate-800">

    <header class="bg-white border-b border-slate-200 px-4 flex justify-between items-center shadow-sm z-30">
        <div class="flex items-center gap-2">
            <img src="https://static.wixstatic.com/media/dd5dab_7e61f61a3fab4046946b861015ab0f2d~mv2.avif/v1/fill/w_124,h_59,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/Design%20sans%20titre.avif" alt="Logo" class="h-5 w-auto">
            <span class="font-black text-xs uppercase tracking-tight text-slate-700 hidden sm:inline">Map Ta Mobilit√©</span>
        </div>
        <div class="flex gap-2">
            <!-- BOUTON DIAG 360 -->
            <a href="https://mlpb-tools.github.io/diagmob360/" target="_blank" class="bg-purple-100 hover:bg-purple-200 text-purple-700 border border-purple-300 px-2 py-1 text-[9px] font-bold rounded uppercase flex items-center gap-1 transition-colors">
                <span>üìä</span> Diag 360
            </a>

            <label for="map-upload" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-2 py-1 text-[9px] font-bold rounded border border-slate-300 uppercase flex items-center gap-1"><span>üìÇ</span> Import</label>
            <input type="file" id="map-upload" accept="image/*" class="hidden" onchange="handleMapUpload(event)">
            
            <button onclick="toggleLibrary()" class="bg-blue-500 text-white px-2 py-1 text-[9px] font-bold rounded hover:bg-blue-600 uppercase flex items-center gap-1">üìö Biblio</button>
            <button onclick="saveSession()" class="bg-emerald-500 text-white px-2 py-1 text-[9px] font-bold rounded hover:bg-emerald-600 uppercase flex items-center gap-1" title="Enregistrer">üíæ Sauver</button>
            <button onclick="analyzeMapWithAI()" id="btn-analyze" class="bg-indigo-600 text-white px-2 py-1 text-[9px] font-bold rounded hover:bg-indigo-500 uppercase flex items-center gap-1 ml-2">‚ú® IA</button>
            <button onclick="openRoadbook()" class="bg-yellow-400 text-slate-900 px-2 py-1 text-[9px] font-bold rounded hover:bg-yellow-300 uppercase">PDF</button>
        </div>
    </header>

    <div class="cockpit-container">
        <!-- SIDEBAR GAUCHE -->
        <aside class="sidebar-left">
            <div class="nav-column">
                <div onclick="switchTab('lieux', this)" class="nav-btn active" title="Lieux de Vie"><span class="nav-icon">üè†</span></div>
                <div onclick="switchTab('transports', this)" class="nav-btn" title="Transports"><span class="nav-icon">üöå</span></div>
                <div onclick="switchTab('pro', this)" class="nav-btn" title="Emploi & Formation"><span class="nav-icon">üíº</span></div>
                <div onclick="switchTab('admin', this)" class="nav-btn" title="Admin & Sant√©"><span class="nav-icon">‚öïÔ∏è</span></div>
                <div onclick="switchTab('loisirs', this)" class="nav-btn" title="Loisirs & Culture"><span class="nav-icon">üéâ</span></div>
                <div onclick="switchTab('freins', this)" class="nav-btn" title="Freins"><span class="nav-icon">üöß</span></div>
            </div>
            
            <div class="tools-column">
                <div id="tools-title" class="tools-header">Lieux de Vie</div>
                <div class="flex-1 overflow-y-auto bg-slate-50 relative custom-scrollbar">
                    <div id="content-lieux" class="tools-grid"></div>
                    <div id="content-transports" class="tools-grid hidden"></div>
                    <div id="content-pro" class="tools-grid hidden"></div>
                    <div id="content-admin" class="tools-grid hidden"></div>
                    <div id="content-loisirs" class="tools-grid hidden"></div>
                    <div id="content-freins" class="tools-grid hidden"></div>
                </div>
            </div>
        </aside>

        <!-- CENTRE MAP -->
        <main class="map-stage">
            <div id="board-container">
                <div id="map-transform-layer">
                    <div id="placeholder-text" class="absolute flex flex-col items-center justify-center text-slate-400 pointer-events-none opacity-60">
                        <span class="text-4xl mb-2">üó∫Ô∏è</span>
                        <span class="font-bold text-xs uppercase text-center">Choisis un mod√®le<br>ou importe ta carte</span>
                    </div>
                    <img id="user-map-img" src="" class="hidden" alt="Fond">
                    <div id="drop-zone" class="absolute inset-0 z-10 w-full h-full"></div>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="resetZoom()">1:1</button>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                </div>

                <div id="chat-overlay" class="chat-overlay hidden">
                    <div class="bg-slate-800 text-white p-2 rounded-t flex justify-between items-center text-xs font-bold">
                        <span>ü§ñ Coach IA</span>
                        <button onclick="toggleChat()" class="hover:text-red-400">‚úï</button>
                    </div>
                    <div id="chat-messages" class="chat-messages"><div class="chat-bubble chat-ai">Pose ta question sur le permis ou Txik Txak !</div></div>
                    <div class="p-2 bg-white border-t border-slate-100 flex gap-1">
                        <input type="text" id="chat-input" class="flex-1 border text-xs p-1 rounded" onkeypress="handleChatKey(event)">
                        <button onclick="sendMessage()" class="bg-blue-600 text-white px-2 rounded text-xs">‚û§</button>
                    </div>
                </div>
            </div>
            <div id="toast-message" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-3 py-1 rounded-full shadow-lg z-50 text-[10px] font-bold hidden backdrop-blur-sm pointer-events-none"></div>
        </main>

        <!-- SIDEBAR DROITE -->
        <aside class="sidebar-right">
            <span class="text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest">Zones</span>
            <button onclick="addZone(150, 'rgba(34, 197, 94, 0.15)', '#16a34a', 'CONFORT')" class="zone-btn border-green-500 text-green-700 hover:bg-green-50"><span class="text-xl">üòé</span> Confort</button>
            <button onclick="addZone(250, 'rgba(234, 179, 8, 0.15)', '#ca8a04', 'EFFORT')" class="zone-btn border-yellow-500 text-yellow-700 hover:bg-yellow-50"><span class="text-xl">ü§î</span> Effort</button>
            <button onclick="addZone(350, 'rgba(239, 68, 68, 0.15)', '#ef4444', 'GAL√àRE')" class="zone-btn border-red-500 text-red-700 hover:bg-red-50"><span class="text-xl">üö´</span> Gal√®re</button>
            <div class="flex-1"></div>
            <span class="text-[9px] font-black uppercase text-slate-400 mb-1 tracking-widest">Score</span>
            <span id="progress-text" class="text-xs font-bold text-blue-600">0%</span>
            <div class="v-progress-track"><div id="progress-bar" class="v-progress-fill h-0"></div></div>
            <button onclick="toggleChat()" class="mt-4 mb-4 bg-slate-900 text-white w-10 h-10 rounded-full flex items-center justify-center hover:scale-110 transition-transform shadow-lg"><span class="text-lg">üí¨</span></button>
        </aside>
    </div>

    <!-- MODALE BIBLIOTH√àQUE -->
    <div id="library-modal" class="library-modal">
        <div class="library-content">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="font-black text-sm uppercase text-slate-700">Biblioth√®que de cartes</h3>
                <button onclick="toggleLibrary()" class="text-slate-400 hover:text-red-500 font-bold">‚úï</button>
            </div>
            <!-- Zone d'info -->
            <div class="bg-blue-50 text-blue-800 text-[10px] px-4 py-2 font-medium border-b border-blue-100 flex items-center gap-2">
                <span>‚ÑπÔ∏è</span> 
                <span>Importez vos propres cartes ou captures d'√©cran.</span>
            </div>
            <div class="library-grid" id="library-grid">
                <label for="lib-upload-input" class="map-card" style="border: 2px dashed #94a3b8; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8fafc; color:#64748b;">
                    <span style="font-size:32px;">+</span><span style="font-size:10px; font-weight:800; text-transform:uppercase;">Importer</span>
                    <input type="file" id="lib-upload-input" class="hidden" accept="image/*" onchange="handleLibraryUpload(event)">
                </label>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const contextPrompt = `Tu es l'assistant virtuel de la Mission Locale Pays Basque pour l'atelier "Map Ta Mobilit√©". Tu connais le territoire par c≈ìur. Infos cl√©s : Txik Txak (Bus, Tram'Bus, Navette), Offre Solidaire, Permis (Aide Apprentis 500‚Ç¨, FAJ), Locations V√©libleu. Ton but : aider les jeunes NEET √† trouver des solutions.`;
        
        let placedItems = [];
        let currentScale = 1;

        // --- TAXONOMIE ---
        const taxonomy = {
            lieux: [
                { icon: "üè†", label: "Maison / Appart", type: "lieu" },
                { icon: "üè¢", label: "FJT (Foyer)", type: "lieu" },
                { icon: "üõèÔ∏è", label: "H√©berg√©(e)", type: "lieu" },
                { icon: "üèòÔ∏è", label: "Mon Quartier", type: "lieu" },
                { icon: "üå≥", label: "Village / Isol√©", type: "lieu" }
            ],
            transports: [
                { icon: "üö∂", label: "√Ä Pied / Marche", type: "transport" },
                { icon: "üöå", label: "Bus Txik Txak", type: "transport" },
                { icon: "üöã", label: "Tram'Bus", type: "transport" },
                { icon: "üöê", label: "TAD (Demande)", type: "transport" },
                { icon: "üöç", label: "Car Express", type: "transport" },
                { icon: "üöÜ", label: "Train / TER", type: "transport" },
                { icon: "üö≤", label: "Mon V√©lo", type: "transport" },
                { icon: "üö≤", label: "V√©libleu (Loc)", type: "transport" },
                { icon: "üõµ", label: "Scooter / BSR", type: "transport" },
                { icon: "üöò", label: "Voiture Permis B", type: "transport" },
                { icon: "üöó", label: "Passager / Covoit", type: "transport" },
                { icon: "üëç", label: "Auto-Stop", type: "transport" },
                { icon: "üö¶", label: "Auto-√âcole", type: "transport" },
                { icon: "üìñ", label: "Code de la Route", type: "transport" }
            ],
            pro: [
                { icon: "üöÄ", label: "Mission Locale", type: "pro" },
                { icon: "üèõÔ∏è", label: "France Travail", type: "pro" },
                { icon: "üè¢", label: "Entreprise (Usine/BTP)", type: "pro", editable: true, placeholder: "Nom Entreprise" }, 
                { icon: "ü§ù", label: "Bo√Æte Int√©rim", type: "pro", editable: true, placeholder: "Nom Agence" },
                { icon: "üéì", label: "CFA / Formation", type: "pro", editable: true, placeholder: "Nom Centre" },
                { icon: "üßë‚Äçüîß", label: "Stage Immersion", type: "pro" }
            ],
            admin: [
                { icon: "üìä", label: "Mon Score Diag360", type: "admin", editable: true, placeholder: "R√©sultat / Frein" },
                { icon: "üìÇ", label: "Administration", type: "admin", editable: true, placeholder: "Nom Admin" },
                { icon: "üè•", label: "H√¥pital / Urgences", type: "admin" },
                { icon: "ü©∫", label: "M√©decin / CPAM", type: "admin" },
                { icon: "üß†", label: "CMP (Psy)", type: "admin" },
                { icon: "üíä", label: "Pharmacie", type: "admin" },
                { icon: "üë™", label: "Planning Familial", type: "admin" },
                { icon: "üìú", label: "Mairie / CCAS", type: "admin" },
                { icon: "üí∂", label: "CAF / Aides", type: "admin" },
                { icon: "üè¶", label: "Banque", type: "admin" }
            ],
            loisirs: [
                { icon: "ü§ù", label: "B√©n√©volat", type: "loisir" },
                { icon: "üè†", label: "Gaztetxe", type: "loisir" },
                { icon: "üõí", label: "Supermarch√©", type: "loisir" },
                { icon: "ü•ñ", label: "√âpicerie Solidaire", type: "loisir" },
                { icon: "üåä", label: "Oc√©an / Plage", type: "loisir" },
                { icon: "‚öΩ", label: "Stade / Sport", type: "loisir" },
                { icon: "üé™", label: "F√™tes / Festival", type: "loisir" },
                { icon: "‚òï", label: "Tiers-Lieu / Caf√©", type: "loisir" },
                { icon: "üéÆ", label: "M√©diath√®que", type: "loisir" }
            ],
            freins: [
                { icon: "üí∏", label: "Trop Cher", type: "frein" },
                { icon: "üò®", label: "Peur / Stress", type: "frein" },
                { icon: "‚è≥", label: "Trop Long", type: "frein" },
                { icon: "üåë", label: "Pas d'Horaires", type: "frein" },
                { icon: "üì°", label: "Zone Blanche", type: "frein" },
                { icon: "üß≠", label: "Je suis perdu(e)", type: "frein" },
                { icon: "ü¶µ", label: "Fatigue Physique", type: "frein" }
            ]
        };

        // --- INIT & UI ---
        window.addEventListener('load', () => { renderAllTools(); loadLibraryFromStorage(); renderLibrary(); });

        function switchTab(id, btnElement) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            document.querySelectorAll('.tools-grid').forEach(g => g.classList.add('hidden'));
            document.getElementById('content-'+id).classList.remove('hidden');
            document.getElementById('tools-title').innerText = { lieux:"Ancrage & Vie", transports:"Mobilit√© & Permis", pro:"Emploi & Avenir", admin:"Sant√© & Papiers", loisirs:"Vie Sociale", freins:"Obstacles" }[id];
        }

        function renderAllTools() {
            for (const [cat, items] of Object.entries(taxonomy)) {
                const c = document.getElementById(`content-${cat}`);
                items.forEach(item => {
                    const d = document.createElement('div');
                    d.className = `tool-item type-${item.type}`;
                    d.innerHTML = `<span style="font-size:20px; margin-right:10px; min-width:24px; text-align:center;">${item.icon}</span><span class="text-[9px] font-bold uppercase text-slate-700 leading-tight">${item.label}</span>`;
                    d.onclick = () => addToMap(item);
                    c.appendChild(d);
                });
            }
        }

        // --- LIBRARY LOGIC ---
        
        let customLibrary = [
            // Cartes Web (Toujours accessibles)
            { id: 'web-pb', name: "Pays Basque (Global)", url: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Pays_basque_%28fr%29.svg/1200px-Pays_basque_%28fr%29.svg.png", isDefault: true },
            { id: 'web-bab', name: "C≈ìur d'Agglo (BAB)", url: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/Communaut%C3%A9_d%27agglom%C3%A9ration_du_Pays_Basque_-_C%C3%B4te_Basque-Adour.svg/800px-Communaut%C3%A9_d%27agglom%C3%A9ration_du_Pays_Basque_-_C%C3%B4te_Basque-Adour.svg.png", isDefault: true },

            // Fond vierge
            { id: 'default-blank', name: "Fond Vierge", url: "", color: "#ffffff", isDefault: true }
        ];

        function loadLibraryFromStorage() { 
            const s = localStorage.getItem('mlpb_custom_library'); 
            if(s) {
                try { 
                    const stored = JSON.parse(s);
                    // On garde les d√©fauts + les customs
                    const customs = stored.filter(m => !customLibrary.some(def => def.id === m.id));
                    customLibrary = [...customLibrary, ...customs];
                } catch(e){} 
            }
        }
        
        function saveLibraryToStorage() { 
            try { 
                // On ne sauve que ce qui n'est pas "isDefault" pour √©viter de dupliquer les cartes de base
                localStorage.setItem('mlpb_custom_library', JSON.stringify(customLibrary.filter(m => !m.isDefault))); 
            } catch(e) { showToast("‚ö†Ô∏è", "Plein"); } 
        }
        
        function renderLibrary() { 
            const g = document.getElementById('library-grid'); 
            const btn = g.firstElementChild; // Le bouton d'ajout
            g.innerHTML=''; 
            g.appendChild(btn); 
            
            customLibrary.forEach(m => { 
                const c = document.createElement('div'); 
                c.className = 'map-card'; 
                // Ajout de l'attribut title pour le tooltip
                c.title = m.name; 
                
                const style = m.url 
                    ? `background-image:url('${m.url}');background-size:cover;background-position:center;` 
                    : `background-color:${m.color||'#fff'};`;
                
                const deleteBtn = !m.isDefault 
                    ? `<div class="delete-map-btn" onclick="event.stopPropagation();deleteFromLibrary('${m.id}')">‚úï</div>` 
                    : '';
                    
                c.innerHTML = `<div class="map-preview" style="${style}"></div><div class="map-title">${m.name}</div>${deleteBtn}`; 
                c.onclick = () => selectMapTemplate(m.url); 
                g.appendChild(c); 
            }); 
        }

        function handleLibraryUpload(e) { 
            const f = e.target.files[0]; 
            if (!f) return; 
            
            const r = new FileReader(); 
            r.onload = function(ev) { 
                // Nettoyage du nom de fichier (retirer l'extension)
                let rawName = f.name.replace(/\.[^/.]+$/, "");
                
                // Renommage sp√©cifique demand√© pour "Design sans titre"
                let finalName = rawName.substring(0, 20);
                if (rawName.toLowerCase().includes("design sans titre")) {
                    finalName = "Pays Basque";
                }
                
                // isDefault = false permet la suppression
                customLibrary.push({ 
                    id: 'map-' + Date.now(), 
                    name: finalName, 
                    url: ev.target.result, 
                    isDefault: false 
                }); 
                
                saveLibraryToStorage(); 
                renderLibrary(); 
                showToast("‚úÖ", "Ajout√©"); 
            }; 
            r.readAsDataURL(f); 
            e.target.value = ''; 
        }
        
        function deleteFromLibrary(id) { 
            if(confirm("Supprimer ?")) { 
                customLibrary = customLibrary.filter(m => m.id !== id); 
                saveLibraryToStorage(); 
                renderLibrary(); 
            } 
        }
        
        function toggleLibrary() { document.getElementById('library-modal').classList.toggle('active'); }
        
        function selectMapTemplate(url) { 
            const i=document.getElementById('user-map-img'); 
            if(url){ 
                i.src=url; i.classList.remove('hidden'); 
                document.getElementById('placeholder-text').classList.add('hidden'); 
            } else { 
                i.classList.add('hidden'); 
                document.getElementById('placeholder-text').classList.remove('hidden'); 
            } 
            toggleLibrary(); 
        }

        function handleMapUpload(e) { 
            const f=e.target.files[0]; if(f) { 
                const r=new FileReader(); 
                r.onload=function(ev){ 
                    document.getElementById('user-map-img').src=ev.target.result; 
                    document.getElementById('user-map-img').classList.remove('hidden'); 
                    document.getElementById('placeholder-text').classList.add('hidden'); 
                }; 
                r.readAsDataURL(f); 
            } 
        }

        // --- MAP LOGIC (STICKERS & INPUTS) ---
        function addToMap(item) {
            const dropZone = document.getElementById('drop-zone');
            const el = document.createElement('div');
            el.className = 'draggable pointer-events-auto';
            el.style.left = '50%'; el.style.top = '50%';
            placedItems.push({ ...item, el: el });

            let contentHtml = '';
            if (item.editable) {
                contentHtml = `<div class="icon-content"><span class="sticker-emoji">${item.icon}</span><input type="text" class="sticker-input" placeholder="${item.placeholder || 'Nom...'}" value="" onclick="event.stopPropagation(); this.focus();" onmousedown="event.stopPropagation();" ontouchstart="event.stopPropagation();"></div>`;
            } else {
                contentHtml = `<div class="icon-content"><span class="sticker-emoji">${item.icon}</span><span class="sticker-label">${item.label}</span></div>`;
            }

            el.innerHTML = `${contentHtml}<div class="delete-sticker-btn" onclick="event.stopPropagation(); removeItem(this, '${item.label}')">‚úï</div>`;
            enableDrag(el);
            dropZone.appendChild(el);
            updateProgress(1);
        }

        function removeItem(btn, label) { btn.parentElement.remove(); const idx = placedItems.findIndex(i => i.label === label); if(idx>-1) placedItems.splice(idx,1); updateProgress(-1); }

        function enableDrag(el, handle = null) {
            let isDragging=false, startX, startY, iL, iT; const t=handle||el;
            function start(e) { if(e.target.classList.contains('delete-sticker-btn') || e.target.tagName === 'INPUT') return; e.stopPropagation(); isDragging=true; el.style.zIndex=2000; const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY; startX=cx; startY=cy; iL=parseFloat(el.style.left)||50; iT=parseFloat(el.style.top)||50; document.addEventListener('mousemove', move, {passive:false}); document.addEventListener('touchmove', move, {passive:false}); document.addEventListener('mouseup', end); document.addEventListener('touchend', end); }
            function move(e) { if(!isDragging)return; e.preventDefault(); const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY; const r=document.getElementById('drop-zone').getBoundingClientRect(); el.style.left=(iL+((cx-startX)/r.width)*100)+'%'; el.style.top=(iT+((cy-startY)/r.height)*100)+'%'; }
            function end() { isDragging=false; el.style.zIndex=1000; document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end); }
            t.addEventListener('mousedown', start); t.addEventListener('touchstart', start, {passive:false});
        }

        function addZone(size, bg, border, label) { const z=document.createElement('div'); z.className='circle-zone group'; z.style.width=size+'px'; z.style.height=size+'px'; z.style.left='50%'; z.style.top='50%'; z.style.backgroundColor=bg; z.style.borderColor=border; z.innerHTML=`<span class="text-[8px] font-bold text-slate-700 bg-white/90 px-1.5 py-0.5 rounded absolute top-2 border border-slate-200 shadow-sm pointer-events-none select-none whitespace-nowrap">${label}</span><button class="absolute -top-2 -right-2 w-4 h-4 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold border border-white shadow-sm pointer-events-auto z-30 text-[8px]" onmousedown="event.stopPropagation(); this.parentElement.remove();">√ó</button><div class="absolute w-8 h-8 bg-white/30 rounded-full pointer-events-auto flex items-center justify-center cursor-move text-[10px] text-slate-700 z-10 hover:bg-white/50">‚ú•</div>`; enableDrag(z, z.querySelector('.cursor-move')); document.getElementById('drop-zone').appendChild(z); updateProgress(1); }

        function zoomIn() { currentScale+=0.1; updT(); } function zoomOut() { if(currentScale>0.2)currentScale-=0.1; updT(); } function resetZoom() { currentScale=1; updT(); } function updT() { document.getElementById('map-transform-layer').style.transform=`scale(${currentScale})`; }
        function saveSession() { const itemsToSave = placedItems.map(item => { let userText = null; if(item.editable) { const input = item.el.querySelector('input'); if(input) userText = input.value; } return { label: item.label, type: item.type, icon: item.icon, left: item.el.style.left, top: item.el.style.top, editable: item.editable, placeholder: item.placeholder, customValue: userText }; }); const imgSrc = document.getElementById('user-map-img').src; const hasImage = !document.getElementById('user-map-img').classList.contains('hidden'); const data = { items: itemsToSave, image: hasImage ? imgSrc : null, date: new Date().toISOString() }; try { localStorage.setItem('mlpb_map_data', JSON.stringify(data)); showToast("üíæ", "Sauv√© !"); } catch(e) { showToast("‚ö†Ô∏è", "Erreur"); } }
        let progress=0; function updateProgress(d) { progress=Math.max(0,Math.min(10,progress+d)); let p=progress*10; document.getElementById('progress-bar').style.height=p+'%'; document.getElementById('progress-text').innerText=p+'%'; }
        function toggleChat() { document.getElementById('chat-overlay').classList.toggle('hidden'); }
        function handleChatKey(e) { if(e.key==='Enter') sendMessage(); }
        async function sendMessage() { const i=document.getElementById('chat-input'); const m=i.value.trim(); if(!m)return; addMsg(m,'user'); i.value=''; addMsg("...",'ai',true); const r=await callGemini(m); document.querySelector('.animate-pulse').parentElement.remove(); addMsg(r,'ai'); }
        function addMsg(t,s,l=false) { const d=document.createElement('div'); d.className=`chat-bubble ${s==='user'?'chat-user':'chat-ai'}`; if(l)d.innerHTML='<span class="animate-pulse">...</span>'; else if(s==='ai')d.innerHTML=marked.parse(t); else d.innerText=t; document.getElementById('chat-messages').appendChild(d); }
        async function analyzeMapWithAI() { if(!placedItems.length)return alert("Carte vide!"); toggleChat(); addMsg("Analyse...",'ai'); const p=`Carte: ${placedItems.map(i=>i.label).join(', ')}. Conseil court.`; const r=await callGemini(p); addMsg(r,'ai'); }
        async function callGemini(m) { try { const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:m}]}],systemInstruction:{parts:[{text:contextPrompt}]}})}); const d=await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text||"Erreur"; } catch(e){return "Erreur";} }
        function openRoadbook() { const w=window.open('','_blank'); w.document.write('<html><body style="text-align:center;padding:50px;font-family:sans-serif;"><h1>Roadbook</h1><button onclick="window.print()">Imprimer</button></body></html>'); }
        function showToast(i,m) { const t=document.getElementById('toast-message'); t.innerHTML=`<span>${i}</span> <span>${m}</span>`; t.classList.remove('hidden'); t.style.opacity=1; setTimeout(()=>{t.style.opacity=0;setTimeout(()=>t.classList.add('hidden'),300);},1500); }
    </script>
</body>
</html>
